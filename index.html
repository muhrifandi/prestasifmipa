<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistem Data Prestasi | FMIPA Unsulbar</title>
  <meta name="description" content="Sistem Data Prestasi FMIPA Unsulbar - SPA (Supabase)">
  <script src="https://cdn.tailwindcss.com" onerror="document.documentElement.dataset.tw='off'"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" onerror="window.__chartOffline=true"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" onerror="window.__pdfOffline=true"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--brand1:#5a79f0;--brand2:#2f3ea8}
    .brand-hero{background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#fff}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.55rem .9rem;border-radius:.8rem;border:1px solid #e5e7eb;background:#fff}
    .btn.primary{background:var(--brand1);color:#fff;border-color:transparent}
    .btn.light{background:#fff;color:#2f3ea8;border:1px solid rgba(255,255,255,.6)}
    .btn.danger{background:#ef4444;color:#fff;border-color:transparent}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:1rem;box-shadow:0 8px 30px rgba(31,41,55,.06)}
    .chip{border:1px solid rgba(99,102,241,.35);padding:.3rem .6rem;border-radius:999px;font-size:.85rem}
    .chip.active{background:rgba(99,102,241,.12)}
    .toast{position:fixed;right:1rem;bottom:1rem;display:flex;flex-direction:column;gap:.5rem;z-index:60}
    .toast-item{background:#0f172a;color:#fff;padding:.7rem 1rem;border-radius:.7rem;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:100}
    .modal-card{background:#fff;border:1px solid #e5e7eb;border-radius:1rem;max-height:90vh;overflow:auto}
    .table-wrap{overflow:auto}.table{min-width:900px;border-collapse:separate;border-spacing:0}
    .table th,.table td{padding:.65rem .75rem;border-bottom:1px solid #e5e7eb;vertical-align:top}
    .table th{font-weight:600;white-space:nowrap;position:sticky;top:0;background:#fff;z-index:1}
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <div id="toast" class="toast"></div>

  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-center justify-between py-3">
        <div class="flex items-center gap-3 min-w-0">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-indigo-700 grid place-items-center text-white font-bold">FM</div>
          <div class="truncate">
            <h1 class="text-lg font-semibold">Sistem Data Prestasi <span class="text-indigo-700">FMIPA</span></h1>
            <p class="text-sm text-gray-600">Universitas Sulawesi Barat</p>
          </div>
        </div>

        <!-- Nav desktop -->
        <nav class="hidden md:flex items-center gap-2">
          <a href="#/beranda" class="px-3 py-2 rounded hover:bg-indigo-50">Beranda</a>
          <div class="relative group">
            <button class="btn">Data ▾</button>
            <div class="absolute hidden group-hover:block bg-white border border-gray-200 rounded-lg shadow-lg p-2 right-0 mt-1 z-40">
              <a href="#/dosen" class="block px-3 py-2 rounded hover:bg-indigo-50">Data Dosen</a>
              <a href="#/mahasiswa" class="block px-3 py-2 rounded hover:bg-indigo-50">Data Mahasiswa</a>
              <a href="#/tendik" class="block px-3 py-2 rounded hover:bg-indigo-50">Data Tenaga Kependidikan</a>
            </div>
          </div>
          <a href="#/laporan" class="px-3 py-2 rounded hover:bg-indigo-50">Laporan</a>
          <a href="#/info" class="px-3 py-2 rounded hover:bg-indigo-50">Informasi</a>
          <a href="#/galeri" class="px-3 py-2 rounded hover:bg-indigo-50">Galeri</a>
          <a href="#/tentang" class="px-3 py-2 rounded hover:bg-indigo-50">Tentang</a>

          <!-- Menu Admin -->
          <div id="menuAdminWrap" class="relative hidden">
            <button id="btnAdminMenu" class="btn">Admin ▾</button>
            <div id="adminMenu" class="hidden absolute right-0 top-full bg-white border border-gray-200 rounded-lg shadow-lg p-2 z-40">
              <button id="miLogout" class="block w-full text-left px-3 py-2 rounded hover:bg-red-50 text-red-600">Logout</button>
            </div>
          </div>

          <button id="btnLogin" class="btn primary">Masuk</button>
        </nav>

        <!-- Mobile -->
        <button id="btnHamburger" class="btn md:hidden" aria-label="Buka menu" aria-expanded="false">☰</button>
      </div>

      <!-- Nav mobile -->
      <div id="mobileMenu" class="md:hidden hidden pb-3">
        <div class="flex flex-col gap-1">
          <a href="#/beranda" class="px-3 py-2 rounded hover:bg-indigo-50">Beranda</a>
          <details class="px-3 py-2">
            <summary class="cursor-pointer">Data</summary>
            <div class="pl-3 py-2 flex flex-col">
              <a href="#/dosen" class="px-3 py-2 rounded hover:bg-indigo-50">Data Dosen</a>
              <a href="#/mahasiswa" class="px-3 py-2 rounded hover:bg-indigo-50">Data Mahasiswa</a>
              <a href="#/tendik" class="px-3 py-2 rounded hover:bg-indigo-50">Data Tenaga Kependidikan</a>
            </div>
          </details>
          <a href="#/laporan" class="px-3 py-2 rounded hover:bg-indigo-50">Laporan</a>
          <a href="#/info" class="px-3 py-2 rounded hover:bg-indigo-50">Informasi</a>
          <a href="#/galeri" class="px-3 py-2 rounded hover:bg-indigo-50">Galeri</a>
          <a href="#/tentang" class="px-3 py-2 rounded hover:bg-indigo-50">Tentang</a>
          <div class="flex gap-2 px-3 mt-2">
            <button id="btnLoginMobile" class="btn primary w-full">Masuk</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Toolbar -->
  <div class="border-b border-gray-200 bg-white">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center gap-2 justify-between">
      <div class="flex items-center gap-2">
        <button id="btnAdd" class="btn primary hidden">➕ Tambah Prestasi</button>
        <button id="btnExportCSV" class="btn hidden">↓ CSV</button>
        <button id="btnExportJSON" class="btn hidden">↓ JSON</button>
      </div>
      <input id="quickSearch" type="search" placeholder="Cari cepat…" class="w-44 sm:w-64 md:w-80 px-3 py-2 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" />
    </div>
  </div>

  <!-- Root -->
  <main id="app" class="max-w-7xl mx-auto px-4 py-6 space-y-6"></main>

  <footer class="mt-10 border-t border-gray-200 py-6 text-sm text-gray-600">
    <div class="max-w-7xl mx-auto px-4 flex items-center justify-between">
      <div>© <span id="year"></span> FMIPA Unsulbar • Sistem Data Prestasi</div>
      <div>SPA • Supabase</div>
    </div>
  </footer>

  <!-- ===== MODALS ===== -->

  <!-- Modal Masuk -->
  <div id="modalLogin" class="modal hidden">
    <div class="modal-card w-full max-w-lg p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Masuk</h3>
        <button class="btn" onclick="closeModal('modalLogin')">✖</button>
      </div>
      <form id="formLogin" class="space-y-3">
        <div><label class="text-sm font-medium">Email</label><input name="email" type="email" required class="w-full px-3 py-2 border rounded-xl" placeholder="nama@unsulbar.ac.id"></div>
        <div><label class="text-sm font-medium">Password</label><input name="password" type="password" required class="w-full px-3 py-2 border rounded-xl" placeholder="••••••••"></div>
        <div class="flex items-center justify-between pt-2">
          <button type="button" class="btn" onclick="closeModal('modalLogin')">Batal</button>
          <div class="text-sm text-gray-600">
            Belum punya akun? <a id="linkOpenSignup" class="underline cursor-pointer">Daftar</a>
          </div>
          <button type="submit" class="btn primary">Masuk</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Sign Up -->
  <div id="modalSignup" class="modal hidden">
    <div class="modal-card w-full max-w-lg p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Daftar Akun</h3>
        <button class="btn" onclick="closeModal('modalSignup')">✖</button>
      </div>
      <form id="formSignup" class="space-y-3">
        <div><label class="text-sm font-medium">Email</label>
          <input name="email" type="email" required class="w-full px-3 py-2 border rounded-xl" placeholder="nama@unsulbar.ac.id"></div>
        <div><label class="text-sm font-medium">Password</label>
          <input name="password" type="password" minlength="6" required class="w-full px-3 py-2 border rounded-xl" placeholder="min 6 karakter"></div>
        <div class="flex items-center justify-end gap-2 pt-2">
          <button type="button" class="btn" onclick="closeModal('modalSignup')">Batal</button>
          <button type="submit" class="btn primary">Daftar</button>
        </div>
      </form>
      <p class="text-xs text-gray-600 mt-2">Setelah daftar, silakan login untuk menambahkan prestasi.</p>
    </div>
  </div>

  <!-- Modal Tambah/Edit Prestasi -->
  <div id="modalForm" class="modal hidden">
    <div class="modal-card w-full max-w-2xl p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 id="modalTitle" class="text-lg font-semibold">Tambah Prestasi</h3>
        <button class="btn" onclick="closeModal('modalForm')">✖</button>
      </div>
      <form id="formPrestasi" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><label class="text-sm font-medium">Kategori <span class="text-red-500">*</span></label>
          <select name="kategori" required class="w-full px-3 py-2 border rounded-xl">
            <option value="">- pilih -</option>
            <option>Mahasiswa</option>
            <option>Dosen</option>
            <option>Tenaga Kependidikan</option>
          </select></div>
        <div><label class="text-sm font-medium">Nama <span class="text-red-500">*</span></label>
          <input name="nama" required class="w-full px-3 py-2 border rounded-xl" placeholder="Nama lengkap"></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Prestasi / Kegiatan <span class="text-red-500">*</span></label>
          <input name="judul" required class="w-full px-3 py-2 border rounded-xl" placeholder="Judul prestasi / lomba / publikasi"></div>
        <div><label class="text-sm font-medium">Tingkat</label>
          <select name="tingkat" class="w-full px-3 py-2 border rounded-xl">
            <option>Universitas</option><option>Kabupaten</option><option>Provinsi</option>
            <option>Regional</option><option>Nasional</option><option>Internasional</option>
          </select></div>
        <div><label class="text-sm font-medium">Jurusan</label>
          <select name="jurusan" class="w-full px-3 py-2 border rounded-xl"><option>Matematika</option><option>Bioteknologi</option></select></div>
        <div><label class="text-sm font-medium">Program Studi</label>
          <select name="prodi" class="w-full px-3 py-2 border rounded-xl"><option>Matematika</option><option>Statistika</option><option>Aktuaria</option><option>Bioteknologi</option></select></div>
        <div><label class="text-sm font-medium">Tahun</label>
          <input name="tahun" type="number" min="2000" max="2100" value="2025" class="w-full px-3 py-2 border rounded-xl"></div>
        <div><label class="text-sm font-medium">Tanggal</label>
          <input name="tanggal" type="date" class="w-full px-3 py-2 border rounded-xl"></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Link Sertifikat (URL)</label>
          <input name="linkSertifikat" type="url" placeholder="https://..." class="w-full px-3 py-2 border rounded-xl"></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Unggah Sertifikat (PDF)</label>
          <input name="pdfSertifikat" type="file" accept="application/pdf" class="w-full px-3 py-2 border rounded-xl bg-white"></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Foto Penyerahan Hadiah (JPG/PNG)</label>
          <input name="fotoPenyerahan" type="file" accept="image/*" class="w-full px-3 py-2 border rounded-xl bg-white"></div>
        <div><label class="text-sm font-medium">Status</label>
          <input name="status" value="Menunggu Validasi" readonly class="w-full px-3 py-2 border rounded-xl bg-gray-100"></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Keterangan</label>
          <textarea name="keterangan" rows="3" class="w-full px-3 py-2 border rounded-xl" placeholder="Opsional"></textarea></div>
        <div class="md:col-span-2 flex items-center justify-end gap-2 pt-2">
          <button type="button" class="btn" onclick="closeModal('modalForm')">Batal</button>
          <button type="submit" class="btn primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Tambah Informasi (Admin only) -->
  <div id="modalInfo" class="modal hidden">
    <div class="modal-card w-full max-w-xl p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Tambah Informasi / Pengumuman</h3>
        <button class="btn" onclick="closeModal('modalInfo')">✖</button>
      </div>
      <form id="formInfo" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><label class="text-sm font-medium">Tipe</label>
          <select name="tipe" class="w-full px-3 py-2 border rounded-xl">
            <option>Informasi</option><option>Pengumuman</option><option>Beasiswa</option><option>Kegiatan</option>
          </select></div>
        <div><label class="text-sm font-medium">Tanggal</label>
          <input name="tanggal" type="date" class="w-full px-3 py-2 border rounded-xl"></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Judul <span class="text-red-500">*</span></label>
          <input name="judul" required class="w-full px-3 py-2 border rounded-xl"></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Isi (ringkas) <span class="text-red-500">*</span></label>
          <textarea name="isi" rows="4" required class="w-full px-3 py-2 border rounded-xl"></textarea></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Tautan (opsional)</label>
          <input name="link" type="url" class="w-full px-3 py-2 border rounded-xl" placeholder="https://..."></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Poster/Gambar (opsional)</label>
          <input name="gambar" type="file" accept="image/*" class="w-full px-3 py-2 border rounded-xl bg-white"></div>
        <div class="md:col-span-2 flex items-center justify-end gap-2 pt-2">
          <button type="button" class="btn" onclick="closeModal('modalInfo')">Batal</button>
          <button type="submit" class="btn primary">Simpan</button>
        </div>
      </form>
      <p class="text-xs text-gray-600 mt-2">Hanya admin yang dapat menambahkan informasi.</p>
    </div>
  </div>

  <!-- Templates -->
  <template id="tpl-beranda">
    <section class="relative overflow-hidden rounded-2xl brand-hero p-6 sm:p-8">
      <div class="max-w-3xl">
        <h2 class="text-2xl sm:text-3xl font-semibold">Sistem Data Prestasi FMIPA</h2>
        <p class="mt-2 text-white/90">Dokumentasi prestasi & informasi akademik yang rapi, mudah diakses, dan siap untuk akreditasi.</p>
        <div class="mt-4 flex items-center gap-2">
          <button id="ctaAdd" class="btn light">➕ Tambah Prestasi</button>
          <a href="#/mahasiswa" class="btn light">Lihat Data</a>
        </div>
      </div>
      <div class="absolute -right-16 -bottom-16 w-64 h-64 rounded-full bg-white/10 blur-2xl"></div>
    </section>

    <!-- 4 Cards -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-6">
      <div class="card p-4">
        <div class="text-sm text-gray-600">Prestasi Mahasiswa</div>
        <div id="countMahasiswa" class="text-3xl font-semibold mt-1">0</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-gray-600">Prestasi Dosen</div>
        <div id="countDosen" class="text-3xl font-semibold mt-1">0</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-gray-600">Prestasi Tendik</div>
        <div id="countTendik" class="text-3xl font-semibold mt-1">0</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-gray-600">Total Prestasi</div>
        <div id="countTotal" class="text-3xl font-semibold mt-1">0</div>
      </div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
      <div>
        <h3 class="text-lg font-semibold mb-3">Prestasi Terbaru</h3>
        <div id="listTerbaru" class="space-y-3"></div>
        <p id="emptyBeranda" class="hidden text-sm text-gray-600">Belum ada data.</p>
      </div>
      <div>
        <h3 class="text-lg font-semibold mb-3">Informasi Terbaru</h3>
        <div id="listInfoTerbaru" class="space-y-3"></div>
        <p id="emptyInfoHome" class="hidden text-sm text-gray-600">Belum ada informasi.</p>
      </div>
    </section>
  </template>

  <template id="tpl-tabel">
    <section>
      <div class="flex flex-wrap items-center gap-2 mb-3">
        <button class="chip" data-chip data-chip-level="All">Semua Tingkat</button>
        <button class="chip" data-chip data-chip-level="Universitas">Universitas</button>
        <button class="chip" data-chip data-chip-level="Kabupaten">Kabupaten</button>
        <button class="chip" data-chip data-chip-level="Provinsi">Provinsi</button>
        <button class="chip" data-chip data-chip-level="Regional">Regional</button>
        <button class="chip" data-chip data-chip-level="Nasional">Nasional</button>
        <button class="chip" data-chip data-chip-level="Internasional">Internasional</button>
        <span class="mx-1 text-gray-300">|</span>
        <button class="chip" data-chip data-chip-status="All">Semua Status</button>
        <button class="chip" data-chip data-chip-status="Menunggu Validasi">Menunggu</button>
        <button class="chip" data-chip data-chip-status="Disetujui">Disetujui</button>
        <button class="chip" data-chip data-chip-status="Ditolak">Ditolak</button>
      </div>
      <div class="card p-4">
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 mb-3">
          <select id="filterJurusan" class="px-3 py-2 border rounded-xl"><option value="">Semua Jurusan</option><option>Matematika</option><option>Bioteknologi</option></select>
          <select id="filterProdi" class="px-3 py-2 border rounded-xl"><option value="">Semua Prodi</option><option>Matematika</option><option>Statistika</option><option>Aktuaria</option><option>Bioteknologi</option></select>
          <select id="filterTingkat" class="px-3 py-2 border rounded-xl">
            <option value="">Semua Tingkat</option>
            <option>Universitas</option><option>Kabupaten</option><option>Provinsi</option><option>Regional</option><option>Nasional</option><option>Internasional</option>
          </select>
          <select id="filterStatus" class="px-3 py-2 border rounded-xl"><option value="">Semua Status</option><option>Menunggu Validasi</option><option>Disetujui</option><option>Ditolak</option></select>
          <select id="pageSize" class="px-3 py-2 border rounded-xl" title="Baris per halaman"><option>10</option><option selected>15</option><option>25</option><option>50</option></select>
        </div>
        <div class="table-wrap -mx-2 sm:mx-0"><div class="min-w-full px-2">
          <table class="table text-sm w-full">
            <thead><tr><th class="sort" data-sort="tanggal">Tanggal</th><th class="sort" data-sort="nama">Nama</th><th class="sort" data-sort="kategori">Kategori</th><th class="sort" data-sort="judul">Prestasi</th><th class="sort" data-sort="tingkat">Tingkat</th><th class="sort" data-sort="jurusan">Jurusan</th><th class="sort" data-sort="prodi">Prodi</th><th class="sort" data-sort="tahun">Tahun</th><th class="sort" data-sort="status">Status</th><th>Link</th><th>Aksi</th></tr></thead>
            <tbody id="tbodyData"></tbody>
          </table></div></div>
        <div class="flex items-center justify-between mt-3">
          <div id="infoPage" class="text-sm text-gray-600"></div>
          <div class="flex items-center gap-2"><button id="prevPage" class="btn">‹</button><span id="pageNow" class="px-2"></span><button id="nextPage" class="btn">›</button></div>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-laporan">
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="lg:col-span-2 flex items-center justify-between">
        <h3 class="text-lg font-semibold">Laporan Prestasi</h3>
        <button id="btnExportPDFReport" class="btn primary">⤓ Export PDF</button>
      </div>
      <div class="card p-4">
        <h3 class="text-lg font-semibold mb-3">Rekap per Kategori</h3>
        <div class="relative h-64"><canvas id="chartKategori" class="absolute inset-0 w-full h-full"></canvas></div>
        <div id="chartKategoriFallback" class="hidden text-sm text-gray-600">Grafik fallback (offline).</div>
      </div>
      <div class="card p-4">
        <h3 class="text-lg font-semibold mb-3">Rekap per Tingkat</h3>
        <div class="relative h-64"><canvas id="chartTingkat" class="absolute inset-0 w-full h-full"></canvas></div>
        <div id="chartTingkatFallback" class="hidden text-sm text-gray-600">Grafik fallback (offline).</div>
      </div>
      <div class="card p-4 lg:col-span-2">
        <h3 class="text-lg font-semibold mb-3">Rekap per Tahun</h3>
        <div class="relative h-64"><canvas id="chartTahun" class="absolute inset-0 w-full h-full"></canvas></div>
        <div id="chartTahunFallback" class="hidden text-sm text-gray-600">Grafik fallback (offline).</div>
      </div>
    </section>
  </template>

  <template id="tpl-galeri"><section><h3 class="text-lg font-semibold mb-3">Galeri Penyerahan Hadiah</h3><div id="gridGaleri" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4"></div><p id="galeriKosong" class="text-sm text-gray-600 hidden mt-2">Belum ada foto yang diunggah.</p></section></template>

  <template id="tpl-info">
    <section class="card p-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Informasi & Pengumuman</h3>
        <button id="btnAddInfo" class="btn">➕ Tambah</button>
      </div>
      <div class="flex items-center gap-2 mt-3">
        <select id="filterInfoTipe" class="px-3 py-2 border rounded-xl">
          <option value="">Semua Tipe</option><option>Informasi</option><option>Pengumuman</option><option>Beasiswa</option><option>Kegiatan</option>
        </select>
        <input id="searchInfo" type="search" placeholder="Cari…" class="px-3 py-2 border rounded-xl" />
      </div>
      <div id="listInfo" class="space-y-3 mt-3"></div>
      <p id="infoKosong" class="text-sm text-gray-600 hidden">Belum ada informasi.</p>
    </section>
  </template>

  <template id="tpl-tentang">
    <section class="card p-4 space-y-3 leading-relaxed">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Tentang FMIPA Unsulbar</h3>
      </div>
      <div id="kontenTentang" class="prose max-w-none">
        <p>FMIPA Universitas Sulawesi Barat berkomitmen pada pengembangan sains dan teknologi yang berdampak.
        Sistem ini mendukung transparansi dan akuntabilitas prestasi sivitas akademika.</p>
        <h4 class="text-base font-semibold mt-4">Struktur Jurusan & Program Studi</h4>
        <ul class="list-disc pl-6"><li><b>Jurusan Matematika</b>: Prodi <i>Matematika</i>, <i>Statistika</i>, <i>Aktuaria</i>.</li><li><b>Jurusan Bioteknologi</b>: Prodi <i>Bioteknologi</i>.</li></ul>
      </div>
    </section>
  </template>

  <!-- ===== SCRIPT APP ===== -->
  <script>
/* ====== KONFIG SUPABASE — GANTI SESUAI PROJECTMU ====== */
const SUPABASE_URL = "https://gaaczshosszdddhrfeii.supabase.co";       // <- ganti
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYWN6c2hvc3N6ZGRkaHJmZWlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NzQ0NjIsImV4cCI6MjA3MTE1MDQ2Mn0.dgXfUP2jl7PEH--u-7pI4aJgpiVCqY8z3HtxEymn0Is";              // <- ganti
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const BUCKET = 'uploads';

/* ===== Utils ===== */
const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>[...e.querySelectorAll(s)];
const byId=id=>document.getElementById(id);
byId('year').textContent=new Date().getFullYear();
function showToast(msg,type='info',ms=2500){const t=byId('toast');const el=document.createElement('div');el.className='toast-item';el.style.background=type==='error'?'#991b1b':(type==='success'?'#14532d':'#0f172a');el.textContent=msg;t.appendChild(el);setTimeout(()=>el.remove(),ms);}
function openModal(id){byId(id).classList.remove('hidden')}
function closeModal(id){byId(id).classList.add('hidden')}
function esc(s=''){return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&gt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function fmtDate(d){if(!d)return'-';const dd=new Date(d);if(isNaN(dd))return d;return dd.toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'});}
function downloadText(fn,txt){const b=new Blob([txt],{type:'text/plain;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=fn;a.click();URL.revokeObjectURL(a.href)}

/* ===== State ===== */
let USER = null;      // Supabase auth user object
let IS_ADMIN = false; // user?.app_metadata?.role === 'admin'
let DATA = [];        // prestasi
let INFO = [];        // informasi

/* ===== Navbar / Mobile ===== */
const btnHamb=byId('btnHamburger'); const mobileMenu=byId('mobileMenu');
btnHamb.addEventListener('click',()=>{const open=mobileMenu.classList.toggle('hidden')===false;btnHamb.setAttribute('aria-expanded',open?'true':'false');});
document.addEventListener('click',(e)=>{if(!e.target.closest('#btnAdminMenu')) byId('adminMenu')?.classList.add('hidden');});

/* ===== Router ===== */
function route(){
  const h=location.hash||'#/beranda';
  if(h.startsWith('#/beranda')) renderBeranda();
  else if(h.startsWith('#/dosen')) renderTabel('Dosen');
  else if(h.startsWith('#/mahasiswa')) renderTabel('Mahasiswa');
  else if(h.startsWith('#/tendik')) renderTabel('Tenaga Kependidikan');
  else if(h.startsWith('#/laporan')) renderLaporan();
  else if(h.startsWith('#/info')) renderInfo();
  else if(h.startsWith('#/galeri')) renderGaleri();
  else if(h.startsWith('#/tentang')) renderTentang();
  else location.hash='#/beranda';
}
window.addEventListener('hashchange',route);

/* ===== Auth helpers ===== */
function computeIsAdmin(user){ try { return (user?.app_metadata?.role === 'admin'); } catch { return false; } }
async function refreshUser(){
  const { data: { user } } = await supa.auth.getUser();
  USER = user || null;
  IS_ADMIN = computeIsAdmin(USER);
  updateAuthUI();
}

/* ===== Update UI by auth ===== */
function updateAuthUI(){
  const loggedIn = !!USER;
  byId('btnAdd').classList.toggle('hidden', !loggedIn); // semua user login boleh tambah
  byId('btnExportCSV').classList.toggle('hidden', !IS_ADMIN);
  byId('btnExportJSON').classList.toggle('hidden', !IS_ADMIN);
  byId('menuAdminWrap').classList.toggle('hidden', !IS_ADMIN);
  byId('btnLogin').classList.toggle('hidden', loggedIn);
  byId('btnLoginMobile').classList.toggle('hidden', loggedIn);
}

/* ===== Data fetch ===== */
async function fetchAll(){
  const { data: prestasi, error: e1 } = await supa.from('prestasi').select('*').order('tanggal', { ascending:false });
  if(e1) console.error(e1); DATA = prestasi||[];
  const { data: infos, error: e2 } = await supa.from('info').select('*').order('tanggal', { ascending:false });
  if(e2) console.error(e2); INFO = infos||[];
}

/* ====== Login / Signup ====== */
byId('btnLogin').onclick=()=>openModal('modalLogin');
byId('btnLoginMobile').onclick=()=>{openModal('modalLogin'); mobileMenu.classList.add('hidden');}
byId('btnAdminMenu').onclick=()=>byId('adminMenu').classList.toggle('hidden');
byId('linkOpenSignup')?.addEventListener('click',()=>{closeModal('modalLogin'); openModal('modalSignup');});

byId('formSignup').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  const email=fd.get('email').trim(); const password=fd.get('password');
  const { data, error } = await supa.auth.signUp({ email, password });
  if(error){ console.error(error); return showToast('Gagal daftar: '+(error.message||''),'error'); }
  showToast('Pendaftaran berhasil. Silakan login.','success');
  closeModal('modalSignup'); openModal('modalLogin');
});

byId('formLogin').addEventListener('submit', async e=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  const email=fd.get('email').trim(), password=fd.get('password');
  const { data, error } = await supa.auth.signInWithPassword({ email, password });
  if(error){ showToast('Login gagal','error'); return; }
  USER = data.user; IS_ADMIN = computeIsAdmin(USER);
  closeModal('modalLogin'); showToast(IS_ADMIN?'Login admin berhasil':'Login berhasil','success');
  await fetchAll(); render();
});

byId('miLogout')?.addEventListener('click',async()=>{
  await supa.auth.signOut();
  USER = null; IS_ADMIN=false; updateAuthUI(); showToast('Logout','success'); render();
});

/* ===== Toolbar ===== */
byId('btnAdd').onclick=()=>{ if(!USER) return showToast('Harus login','error'); $('#modalTitle').textContent='Tambah Prestasi'; const f=byId('formPrestasi'); f.reset(); f.dataset.editId=''; openModal('modalForm'); };

byId('btnExportCSV').onclick=()=>{
  if(!IS_ADMIN) return showToast('Hanya admin','error');
  const cols=['id','kategori','nama','judul','tingkat','jurusan','prodi','tahun','tanggal','status','keterangan','linkSertifikat','pdf_url','foto_url'];
  const lines=[cols.join(',')].concat(DATA.map(o=>cols.map(c=>`"${(o[c]??'').toString().replaceAll('"','""')}"`).join(',')));
  downloadText('prestasi_fmipa.csv',lines.join('\n'));
}
byId('btnExportJSON').onclick=()=>{ if(!IS_ADMIN) return showToast('Hanya admin','error'); downloadText('prestasi_fmipa.json',JSON.stringify(DATA,null,2)); }

/* ===== Simpan Prestasi ===== */
byId('formPrestasi').addEventListener('submit', async e=>{
  e.preventDefault();
  if(!USER) return showToast('Harus login','error');
  const f=e.target, fd=new FormData(f), row=Object.fromEntries(fd.entries());
  row.tahun=Number(row.tahun||new Date().getFullYear());
  row.tanggal=row.tanggal || new Date().toISOString().slice(0,10);
  row.linkSertifikat=row.linkSertifikat?.trim()||'';

  // upload ke storage (jika ada)
  const img=f.fotoPenyerahan.files?.[0]; const pdf=f.pdfSertifikat.files?.[0];
  try{
    if(img){
      const path=`foto/${Date.now()}-${img.name}`; 
      const { error } = await supa.storage.from(BUCKET).upload(path, img);
      if(error) throw error;
      const { data: pub } = supa.storage.from(BUCKET).getPublicUrl(path);
      row.foto_url=pub.publicUrl;
    }
    if(pdf){
      const path=`pdf/${Date.now()}-${pdf.name}`; 
      const { error } = await supa.storage.from(BUCKET).upload(path, pdf);
      if(error) throw error;
      const { data: pub } = supa.storage.from(BUCKET).getPublicUrl(path);
      row.pdf_url=pub.publicUrl;
    }
  }catch(err){ console.error(err); return showToast('Upload gagal','error'); }

  const editId=f.dataset.editId;
  if(editId){
    // edit hanya admin
    if(!IS_ADMIN) return showToast('Hanya admin yang boleh edit','error');
    const { error } = await supa.from('prestasi').update(row).eq('id', editId);
    if(error){ console.error(error); return showToast('Gagal update','error'); }
    showToast('Data diperbarui','success');
  } else {
    row.status='Menunggu Validasi';
    const { error } = await supa.from('prestasi').insert(row);
    if(error){ console.error(error); return showToast('Gagal simpan','error'); }
    showToast('Data ditambahkan','success');
  }
  closeModal('modalForm'); await fetchAll(); render();
});

/* ===== Info (Admin only add) ===== */
function renderInfo(){
  const root=byId('app'); root.innerHTML='';
  root.appendChild(byId('tpl-info').content.cloneNode(true));
  const list=byId('listInfo'); const empty=byId('infoKosong'); const selTipe=byId('filterInfoTipe'); const q=byId('searchInfo');

  byId('btnAddInfo').onclick=()=>{ if(!IS_ADMIN) return showToast('Hanya admin','error'); const f=byId('formInfo'); f.reset(); f.tanggal.value=new Date().toISOString().slice(0,10); openModal('modalInfo'); };
  byId('formInfo').onsubmit=async (e)=>{
    e.preventDefault(); if(!IS_ADMIN) return showToast('Hanya admin','error');
    const f=e.target; const fd=new FormData(f); const rec=Object.fromEntries(fd.entries());
    rec.judul=(rec.judul||'').trim(); rec.isi=(rec.isi||'').trim(); rec.tipe=rec.tipe||'Informasi'; rec.tanggal=rec.tanggal||new Date().toISOString().slice(0,10); rec.link=(rec.link||'').trim();
    if(!rec.judul || !rec.isi) return showToast('Judul & isi wajib','error');
    const img=f.gambar.files?.[0];
    if(img){
      const path=`img/${Date.now()}-${img.name}`;
      const { error: e1 } = await supa.storage.from(BUCKET).upload(path, img);
      if(e1){ console.error(e1); return showToast('Upload gagal','error'); }
      const { data: pub } = supa.storage.from(BUCKET).getPublicUrl(path);
      rec.img_url=pub.publicUrl;
    }
    const { error } = await supa.from('info').insert(rec);
    if(error){ console.error(error); return showToast('Gagal simpan','error'); }
    closeModal('modalInfo'); showToast('Informasi ditambahkan','success'); await fetchAll(); paint();
  };
  selTipe.onchange=paint; q.oninput=paint;

  function paint(){
    list.innerHTML=''; let data=INFO.slice().sort((a,b)=>new Date(b.tanggal)-new Date(a.tanggal));
    const tipe=selTipe.value; const query=q.value.trim().toLowerCase();
    if(tipe) data=data.filter(x=>x.tipe===tipe); if(query) data=data.filter(x=>`${x.judul} ${x.isi}`.toLowerCase().includes(query));
    if(!data.length){ empty.classList.remove('hidden'); return; } empty.classList.add('hidden');
    const now=new Date();
    data.forEach(x=>{
      const isNew=(now - new Date(x.tanggal))/(1000*60*60*24) <= 7;
      const item=document.createElement('div');
      item.className='p-3 border rounded-xl bg-white shadow-sm';
      item.innerHTML=`
        <div class="flex items-start gap-3">
          ${x.img_url?`<img src="${x.img_url}" alt="poster" class="w-20 h-20 rounded-lg object-cover border flex-none">`:''}
          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-2 text-sm text-gray-600">
              <span>${fmtDate(x.tanggal)}</span>
              <span class="px-2 py-0.5 rounded-full text-xs border border-indigo-600/30">${esc(x.tipe||'Informasi')}</span>
              ${isNew?'<span class="px-2 py-0.5 rounded text-xs bg-green-100 text-green-700">NEW</span>':''}
            </div>
            <div class="font-semibold">${esc(x.judul||'-')}</div>
            <div class="text-sm text-gray-700 whitespace-pre-wrap">${esc(x.isi||'')}</div>
            ${x.link?`<a href="${esc(x.link)}" target="_blank" rel="noopener" class="text-sm underline underline-offset-4 text-indigo-700 mt-1 inline-block">Buka tautan</a>`:''}
          </div>
        </div>`;
      list.appendChild(item);
    });
  }
  paint();
}

/* ===== Beranda ===== */
function renderBeranda(){
  const root=byId('app'); root.innerHTML='';
  root.appendChild(byId('tpl-beranda').content.cloneNode(true));
  byId('ctaAdd').onclick=()=>byId('btnAdd').click();

  const m = DATA.filter(x=>x.kategori==='Mahasiswa').length;
  const d = DATA.filter(x=>x.kategori==='Dosen').length;
  const t = DATA.filter(x=>x.kategori==='Tenaga Kependidikan').length;
  byId('countMahasiswa').textContent=m;
  byId('countDosen').textContent=d;
  byId('countTendik').textContent=t;
  byId('countTotal').textContent=DATA.length;

  const list=byId('listTerbaru');
  if(DATA.length===0) byId('emptyBeranda').classList.remove('hidden');
  DATA.slice().sort((a,b)=>new Date(b.tanggal)-new Date(a.tanggal)).slice(0,5).forEach(x=>{
    const div=document.createElement('div');div.className='card p-3 flex items-start justify-between gap-3';
    div.innerHTML=`<div class="min-w-0">
      <div class="text-sm text-gray-600">${fmtDate(x.tanggal)} • <b>${x.kategori}</b> • ${x.tingkat||'-'}</div>
      <div class="font-semibold truncate">${esc(x.judul||'-')}</div>
      <div class="text-sm text-gray-700 truncate">${esc(x.nama||'-')} — ${x.jurusan||'-'}/${x.prodi||'-'}</div>
    </div>
    <span class="px-2 py-0.5 rounded text-xs ${x.status==='Disetujui'?'bg-green-100 text-green-700':x.status==='Ditolak'?'bg-red-100 text-red-700':'bg-amber-100 text-amber-700'}">${x.status||'-'}</span>`;
    list.appendChild(div);
  });

  const infoListEl=byId('listInfoTerbaru'); const infoEmpty=byId('emptyInfoHome');
  if(!INFO.length){ infoEmpty.classList.remove('hidden'); }
  else{
    infoEmpty.classList.add('hidden');
    INFO.slice().sort((a,b)=>new Date(b.tanggal)-new Date(a.tanggal)).slice(0,5).forEach(x=>{
      const wrap=document.createElement('div'); wrap.className='card p-3 flex items-start gap-3';
      wrap.innerHTML=`
        ${x.img_url?`<img src="${x.img_url}" alt="poster" class="w-16 h-16 rounded-lg object-cover border">`:''}
        <div class="min-w-0">
          <div class="text-sm text-gray-600">${fmtDate(x.tanggal)} • <span class="px-2 py-0.5 rounded-full text-xs border border-indigo-600/30">${esc(x.tipe||'Informasi')}</span></div>
          <div class="font-semibold truncate">${esc(x.judul||'-')}</div>
          <div class="text-sm text-gray-700 truncate">${esc(x.isi||'')}</div>
          ${x.link?`<a href="${esc(x.link)}" target="_blank" rel="noopener" class="text-xs underline underline-offset-4 text-indigo-700">Tautan</a>`:''}
        </div>`;
      infoListEl.appendChild(wrap);
    });
  }
}

/* ===== Tabel ===== */
function renderTabel(forKategori){
  const root=byId('app'); root.innerHTML=''; root.appendChild(byId('tpl-tabel').content.cloneNode(true));
  let state={sortBy:'tanggal',sortDir:'desc',page:1,pageSize:Number(byId('pageSize').value||15),filterJurusan:'',filterProdi:'',filterTingkat:'',filterStatus:'',chipLevel:'All',chipStatus:'All'};
  byId('pageSize').onchange=e=>{state.pageSize=Number(e.target.value);state.page=1;paint()}
  byId('filterJurusan').onchange=e=>{state.filterJurusan=e.target.value;state.page=1;paint()}
  byId('filterProdi').onchange=e=>{state.filterProdi=e.target.value;state.page=1;paint()}
  byId('filterTingkat').onchange=e=>{state.filterTingkat=e.target.value;state.page=1;paint()}
  byId('filterStatus').onchange=e=>{state.filterStatus=e.target.value;state.page=1;paint()}
  byId('prevPage').onclick=()=>{if(state.page>1){state.page--;paint()}}
  byId('nextPage').onclick=()=>{state.page++;paint()}
  $$('.sort').forEach(th=>th.onclick=()=>{const k=th.dataset.sort;if(state.sortBy===k) state.sortDir=state.sortDir==='asc'?'desc':'asc'; else{state.sortBy=k;state.sortDir='asc';}paint()});
  $$('[data-chip]').forEach(ch=>ch.onclick=()=>{const lvl=ch.dataset.chipLevel,st=ch.dataset.chipStatus;if(lvl){state.chipLevel=lvl;$$('[data-chip][data-chip-level]').forEach(c=>c.classList.remove('active'));ch.classList.add('active');} if(st){state.chipStatus=st;$$('[data-chip][data-chip-status]').forEach(c=>c.classList.remove('active'));ch.classList.add('active');} state.page=1;paint()});

  function filtered(){
    const q=byId('quickSearch').value.trim().toLowerCase();
    return DATA.filter(x=>{
      if(x.kategori!==forKategori) return false;
      if(state.filterJurusan && x.jurusan!==state.filterJurusan) return false;
      if(state.filterProdi && x.prodi!==state.filterProdi) return false;
      if(state.filterTingkat && x.tingkat!==state.filterTingkat) return false;
      if(state.filterStatus && x.status!==state.filterStatus) return false;
      if(state.chipLevel!=='All' && x.tingkat!==state.chipLevel) return false;
      if(state.chipStatus!=='All' && x.status!==state.chipStatus) return false;
      if(q){const hay=`${x.nama} ${x.judul} ${x.jurusan} ${x.prodi} ${x.tingkat} ${x.status}`.toLowerCase(); if(!hay.includes(q)) return false;}
      return true;
    });
  }
  function sorter(a,b,k){const d=state.sortDir==='asc'?1:-1;let va=a[k],vb=b[k]; if(k==='tahun'){va=Number(va||0);vb=Number(vb||0);} if(k==='tanggal'){va=new Date(a.tanggal||'1970-01-01');vb=new Date(b.tanggal||'1970-01-01');} if(va<vb)return-1*d; if(va>vb)return 1*d; return 0;}
  function paint(){
    const arr=filtered().sort((a,b)=>sorter(a,b,state.sortBy));
    const total=arr.length; const start=(state.page-1)*state.pageSize; const pageItems=arr.slice(start,start+state.pageSize);
    if(start>=total && state.page>1){state.page=Math.max(1,Math.ceil(total/state.pageSize)); return paint();}
    const tbody=byId('tbodyData'); tbody.innerHTML='';
    pageItems.forEach(x=>{
      const tr=document.createElement('tr'); tr.innerHTML=`
        <td>${fmtDate(x.tanggal)}</td>
        <td class="font-medium">${esc(x.nama||'-')}</td>
        <td>${x.kategori||'-'}</td>
        <td class="min-w-[16rem]">${esc(x.judul||'-')}</td>
        <td>${x.tingkat||'-'}</td>
        <td>${x.jurusan||'-'}</td>
        <td>${x.prodi||'-'}</td>
        <td>${x.tahun||'-'}</td>
        <td><span class="px-2 py-0.5 rounded text-xs ${x.status==='Disetujui'?'bg-green-100 text-green-700':x.status==='Ditolak'?'bg-red-100 text-red-700':'bg-amber-100 text-amber-700'}">${x.status||'-'}</span></td>
        <td>
          ${x.linkSertifikat?`<a href="${esc(x.linkSertifikat)}" target="_blank" class="underline underline-offset-4 text-indigo-700">Sertifikat</a>`:''}
          ${x.pdf_url?`${x.linkSertifikat?' • ':''}<a href="${x.pdf_url}" target="_blank" class="underline underline-offset-4 text-indigo-700">PDF</a>`:''}
          ${(!x.linkSertifikat && !x.pdf_url)?'<span class="text-gray-400">-</span>':''}
          ${x.foto_url?' • <a href="#/galeri" class="underline underline-offset-4 text-indigo-700">Foto</a>':''}
        </td>
        <td class="whitespace-nowrap">
          ${IS_ADMIN ? `<div class="flex items-center gap-2">
            <button class="btn primary" title="Setujui" data-approve="${x.id}">✔</button>
            <button class="btn" title="Tolak" data-reject="${x.id}">✖</button>
            <button class="btn" title="Edit" data-edit="${x.id}">✎</button>
            <button class="btn danger" title="Hapus" data-del="${x.id}">🗑</button>
          </div>` : `<span class="text-xs text-gray-500">Login admin untuk mengubah</span>`}
        </td>`;
      tbody.appendChild(tr);
    });
    if(IS_ADMIN){
      $$('[data-approve]').forEach(b=>b.onclick=()=>updateStatus(b.dataset.approve,'Disetujui'));
      $$('[data-reject]').forEach(b=>b.onclick=()=>updateStatus(b.dataset.reject,'Ditolak'));
      $$('[data-del]').forEach(b=>b.onclick=()=>delRow(b.dataset.del));
      $$('[data-edit]').forEach(b=>b.onclick=()=>editRow(b.dataset.edit));
    }
    byId('infoPage').textContent=`${total} data • Urut: ${state.sortBy} (${state.sortDir})`;
    byId('pageNow').textContent=`${state.page} / ${Math.max(1,Math.ceil(total/state.pageSize))}`;
  }
  async function updateStatus(id,st){const { error } = await supa.from('prestasi').update({status:st}).eq('id', id); if(error){console.error(error);return showToast('Gagal update','error');} await fetchAll(); showToast(`Status diubah ke ${st}`,'success'); paint();}
  async function delRow(id){ if(!confirm('Hapus data ini?')) return; const { error } = await supa.from('prestasi').delete().eq('id', id); if(error){console.error(error);return showToast('Gagal hapus','error');} await fetchAll(); showToast('Data dihapus','success'); paint();}
  function editRow(id){
    const x=DATA.find(r=>r.id===id); if(!x)return;
    $('#modalTitle').textContent='Edit Prestasi';
    const f=byId('formPrestasi'); f.reset(); f.dataset.editId=x.id;
    f.kategori.value=x.kategori||''; f.nama.value=x.nama||''; f.judul.value=x.judul||''; f.tingkat.value=x.tingkat||'Universitas';
    f.jurusan.value=x.jurusan||'Matematika'; f.prodi.value=x.prodi||'Matematika'; f.tahun.value=x.tahun||new Date().getFullYear(); f.tanggal.value=x.tanggal?x.tanggal.slice(0,10):'';
    f.status.value=x.status||'Menunggu Validasi'; f.keterangan.value=x.keterangan||''; f.linkSertifikat.value=x.linkSertifikat||'';
    openModal('modalForm');
  }
  paint();
}

/* ===== Laporan ===== */
function renderLaporan(){
  const root=byId('app'); root.innerHTML='';
  root.appendChild(byId('tpl-laporan').content.cloneNode(true));
  const cat=groupCount(DATA,'kategori'), lvl=groupCount(DATA,'tingkat'), th=groupCount(DATA,'tahun');
  makeChartOrFallback('chartKategori','chartKategoriFallback','pie',Object.keys(cat),Object.values(cat));
  makeChartOrFallback('chartTingkat','chartTingkatFallback','bar',Object.keys(lvl),Object.values(lvl));
  const years=Object.keys(th).sort((a,b)=>a-b); makeChartOrFallback('chartTahun','chartTahunFallback','line',years,years.map(y=>th[y]));
  byId('btnExportPDFReport').onclick=exportPDF;
}
function groupCount(a,k){return a.reduce((m,c)=>(m[c[k]]=(m[c[k]]||0)+1,m),{})}
function makeChartOrFallback(id,fid,type,labels,data){
  const ctx=byId(id).getContext('2d');
  if(window.__chartOffline||typeof Chart==='undefined'){
    byId(fid).classList.remove('hidden'); try{ctx.fillText('Grafik tidak tersedia (offline)',10,20);}catch{}
  } else {
    const optsCommon={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:type!=='bar'}}};
    const ds = type==='pie' ? [{data}] : [{label:'Jumlah',data}];
    new Chart(ctx,{type,data:{labels,datasets:ds},options:optsCommon});
  }
}
async function exportPDF(){
  try{
    const { jsPDF } = window.jspdf || {};
    if(!jsPDF) throw new Error('no-jspdf');
    const doc = new jsPDF('p','mm','a4');
    const margin=14;
    doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text('Laporan Prestasi FMIPA Unsulbar', margin, 20);
    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    const total=DATA.length,pending=DATA.filter(x=>x.status==='Menunggu Validasi').length,ok=DATA.filter(x=>x.status==='Disetujui').length,no=DATA.filter(x=>x.status==='Ditolak').length;
    const lines=[`Total Prestasi : ${total}`,`Menunggu Validasi : ${pending}`,`Disetujui : ${ok}`,`Ditolak : ${no}`];
    let y=28; lines.forEach(l=>{doc.text(l, margin, y); y+=6;});
    doc.save(`Laporan-Prestasi-FMIPA-${new Date().toISOString().slice(0,10)}.pdf`);
    showToast('PDF laporan berhasil dibuat','success');
  }catch(e){ window.print(); }
}

/* ===== Galeri & Tentang ===== */
function renderGaleri(){
  const root=byId('app'); root.innerHTML=''; root.appendChild(byId('tpl-galeri').content.cloneNode(true));
  const grid=byId('gridGaleri'); grid.innerHTML='';
  const fotos=DATA.filter(x=>x.foto_url);
  if(!fotos.length){ byId('galeriKosong').classList.remove('hidden'); return; }
  fotos.forEach(x=>{
    const card=document.createElement('div'); card.className='card p-2';
    card.innerHTML=`<img src="${x.foto_url}" alt="Foto ${esc(x.nama||'')}" class="w-full h-40 object-cover rounded-xl">
      <div class="p-2"><div class="font-semibold text-sm truncate">${esc(x.nama||'-')} • ${x.kategori||'-'}</div>
      <div class="text-xs text-gray-600 truncate">${esc(x.judul||'-')}</div>
      <div class="text-xs text-gray-500">${fmtDate(x.tanggal)} • ${x.tingkat||'-'}</div></div>`;
    grid.appendChild(card);
  });
}
function renderTentang(){
  const root=byId('app'); root.innerHTML=''; root.appendChild(byId('tpl-tentang').content.cloneNode(true));
}

/* ===== Render helpers ===== */
async function render(){ await fetchAll(); route(); }

/* ===== Init ===== */
refreshUser().then(render);

// keyboard: Ctrl+/ fokus search
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='/'){e.preventDefault();byId('quickSearch').focus();}});

  </script>
</body>
</html>
