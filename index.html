<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistem Data Prestasi | FMIPA Unsulbar</title>
  <meta name="description" content="Sistem Data Prestasi Dosen, Mahasiswa, dan Tenaga Kependidikan (Tendik) FMIPA Unsulbar - SPA Offline/Online">

  <!-- Favicon default; akan diganti menjadi logo saat logo berhasil dimuat -->
  <link id="favicon" rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%2324346c"/><text x="50%25" y="58%25" text-anchor="middle" font-family="Arial" font-size="16" fill="white">FM</text></svg>' />

  <!-- Tailwind CONFIG (HARUS sebelum CDN) -->
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      theme: {
        extend: {
          colors: { brand:{50:'#f6f7ff',500:'#6b8cff',600:'#5a79f0',700:'#4459c4'} },
          boxShadow: { soft:'0 10px 30px rgba(0,0,0,.08)' }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com" onerror="document.documentElement.dataset.tw='off'"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" onerror="window.__chartOffline=true"></script>
  <!-- jsPDF untuk Export PDF (fallback ke print jika gagal dimuat) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" onerror="window.__pdfOffline=true"></script>

  <!-- Fallback CSS dasar jika Tailwind gagal -->
  <style>
    :root { --bg:#f7f8fb; --fg:#0f172a; --card:#ffffff; --border:#e5e7eb; --muted:#64748b; }
    [data-tw="off"] body{background:var(--bg);color:var(--fg)}
    [data-tw="off"] header,[data-tw="off"] .toolbar{background:var(--card);border-bottom:1px solid var(--border)}
    [data-tw="off"] .container{max-width:1200px;margin:0 auto;padding:0 1rem}
    [data-tw="off"] .hidden{display:none} [data-tw="off"] .flex{display:flex}
    [data-tw="off"] .items-center{align-items:center} [data-tw="off"] .justify-between{justify-content:space-between}
    [data-tw="off"] .gap-1{gap:.25rem} [data-tw="off"] .gap-2{gap:.5rem} [data-tw="off"] .gap-3{gap:.75rem}
    [data-tw="off"] .p-2{padding:.5rem} [data-tw="off"] .p-3{padding:.75rem} [data-tw="off"] .p-4{padding:1rem}
    [data-tw="off"] .px-3{padding:0 .75rem} [data-tw="off"] .px-4{padding:0 1rem} [data-tw="off"] .py-2{padding:.5rem 0}
    [data-tw="off"] .rounded-xl{border-radius:1rem} [data-tw="off"] .rounded-2xl{border-radius:1.25rem}
    [data-tw="off"] .w-full{width:100%} [data-tw="off"] .text-sm{font-size:.875rem}

    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.55rem .9rem;border-radius:.8rem;border:1px solid var(--border);background:var(--card)}
    .btn.primary{background:#6b8cff;color:#fff;border-color:transparent}
    .btn.warn{background:#f59e0b;color:#111827;border-color:transparent}
    .btn.danger{background:#ef4444;color:#fff;border-color:transparent}
    .chip{border:1px solid rgba(107,140,255,.35);padding:.35rem .6rem;border-radius:999px;font-size:.825rem}
    .chip.active{background:rgba(107,140,255,.15)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:1.25rem;box-shadow:0 10px 30px rgba(31,41,55,.05)}
    .badge{padding:.25rem .5rem;border-radius:.5rem;font-size:.75rem}
    .badge.wait{background:#fef3c7;color:#92400e}.badge.ok{background:#dcfce7;color:#14532d}.badge.no{background:#fee2e2;color:#991b1b}
    .toast{position:fixed;right:1rem;bottom:1rem;display:flex;flex-direction:column;gap:.5rem;z-index:60}
    .toast-item{background:#0f172a;color:#fff;padding:.75rem 1rem;border-radius:.75rem;box-shadow:0 8px 30px rgba(0,0,0,.25)}

    .table-wrap{overflow:auto}
    .table{min-width:900px;border-collapse:separate;border-spacing:0}
    .table th,.table td{padding:.65rem .75rem;border-bottom:1px solid #e5e7eb;vertical-align:top}
    .table th{font-weight:600;white-space:nowrap;position:sticky;top:0;background:#fff;z-index:1}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:100}
    .modal-card{background:#fff;border:1px solid #e5e7eb;max-height:90vh;overflow:auto;border-radius:1.25rem}

    .nav-link{white-space:nowrap;padding:.5rem .75rem;border-radius:.75rem}
    .nav-link:hover{background:rgba(107,140,255,.12)}
    .nav-active{color:#4459c4;font-weight:700;background:rgba(107,140,255,.12)}
    .brand-grad{background:linear-gradient(135deg,#6b8cff,#9a7bff);-webkit-background-clip:text;background-clip:text;color:transparent}
    .dropdown{position:relative}
    .menu{position:absolute;right:0;top:100%;background:#fff;border:1px solid #e5e7eb;border-radius:.75rem;box-shadow:0 10px 30px rgba(31,41,55,.1);padding:.4rem;min-width:180px;z-index:90}
    .menu a,.menu button{display:flex;width:100%;text-align:left;padding:.55rem .75rem;border-radius:.6rem}
    .menu a:hover,.menu button:hover{background:#f6f7ff}
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="container max-w-screen-xl mx-auto px-4">
      <div class="flex items-center justify-between py-3">
        <div class="flex items-center gap-3 min-w-0">
          <img id="logoImg" alt="Logo Unsulbar" class="w-10 h-10 rounded-xl object-contain border border-gray-200 shadow-inner" />
          <div class="truncate">
            <h1 class="text-lg font-semibold">Sistem Data Prestasi <span class="brand-grad">FMIPA</span></h1>
            <p class="text-sm text-gray-600">Universitas Sulawesi Barat</p>
          </div>
        </div>

        <!-- Tombol hamburger (HP) -->
        <button id="btnHamburger" class="btn md:hidden" aria-label="Buka menu" aria-expanded="false">☰</button>

        <!-- Nav desktop -->
        <nav id="topnav" class="hidden md:flex items-center gap-1">
          <a href="#/beranda" class="nav-link">Beranda</a>

          <!-- MENU DATA (gabungan) -->
          <div class="dropdown ml-1">
            <button id="btnDataMenu" class="btn rounded-xl" aria-haspopup="menu" aria-expanded="false">Data ▾</button>
            <div id="dataMenu" class="menu hidden">
              <a href="#/dosen">Data Dosen</a>
              <a href="#/mahasiswa">Data Mahasiswa</a>
              <a href="#/tendik">Data Tendik</a>
            </div>
          </div>

          <a href="#/laporan" class="nav-link">Laporan</a>
          <a href="#/info" class="nav-link">Informasi</a>
          <a href="#/galeri" class="nav-link">Galeri</a>
          <a href="#/tentang" class="nav-link">Tentang</a>

          <!-- ADMIN DROPDOWN -->
          <div class="dropdown ml-2">
            <button id="btnAdminMenu" class="btn rounded-xl" aria-haspopup="menu" aria-expanded="false">Admin ▾</button>
            <div id="adminMenu" class="menu hidden">
              <button id="miChangePass">Ganti Password</button>
              <button id="miEditAccount">Edit Akun</button>
              <button id="miAddAdmin">Tambah Admin</button>
              <hr class="my-1 border-gray-200">
              <button id="miLogout" class="text-red-600">Logout</button>
            </div>
          </div>

          <button id="btnLogin" class="btn primary ml-2">Login Admin</button>
        </nav>
      </div>

      <!-- Nav mobile -->
      <div id="mobileMenu" class="md:hidden hidden pb-3">
        <div class="flex flex-col gap-1">
          <a href="#/beranda" class="nav-link">Beranda</a>

          <!-- Tombol buka submenu Data (mobile) -->
          <button id="mDataToggle" class="btn">Data ▾</button>
          <div id="mDataMenu" class="pl-2 hidden flex flex-col gap-1">
            <a href="#/dosen" class="nav-link">Data Dosen</a>
            <a href="#/mahasiswa" class="nav-link">Data Mahasiswa</a>
            <a href="#/tendik" class="nav-link">Data Tendik</a>
          </div>

          <a href="#/laporan" class="nav-link">Laporan</a>
          <a href="#/info" class="nav-link">Informasi</a>
          <a href="#/galeri" class="nav-link">Galeri</a>
          <a href="#/tentang" class="nav-link">Tentang</a>
          <div class="flex flex-col gap-1 pt-1">
            <button id="mChangePass" class="btn hidden">Ganti Password</button>
            <button id="mEditAccount" class="btn hidden">Edit Akun</button>
            <button id="mAddAdmin" class="btn hidden">Tambah Admin</button>
            <button id="mLogout" class="btn hidden">Logout</button>
            <button id="mLogin" class="btn primary">Login Admin</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Toolbar -->
  <div class="toolbar border-b border-gray-200 bg-white">
    <div class="container max-w-screen-xl mx-auto px-4 py-3 flex flex-wrap items-center gap-2 justify-between">
      <div class="flex items-center gap-2">
        <button id="btnAdd" class="btn primary">➕ Tambah Prestasi</button>
        <button id="btnExportCSV" class="btn">↓ CSV</button>
        <button id="btnExportJSON" class="btn">↓ JSON</button>
        <label class="btn cursor-pointer">↑ Impor JSON <input id="inputImport" type="file" accept="application/json" class="hidden"></label>
        <!-- Reset kini hanya untuk admin (disembunyikan default) -->
        <button id="btnReset" class="btn danger hidden" title="Hapus semua data lokal">Reset Data</button>
      </div>
      <input id="quickSearch" type="search" placeholder="Cari cepat…" class="w-44 sm:w-64 md:w-80 px-3 py-2 border rounded-xl outline-none focus:ring-2 focus:ring-brand-500" />
    </div>
  </div>

  <!-- Root -->
  <main id="app" class="container max-w-screen-xl mx-auto px-4 py-6 space-y-6"></main>

  <footer class="mt-10 border-t border-gray-200 py-6 text-sm text-gray-600">
    <div class="container max-w-screen-xl mx-auto px-4 flex items-center justify-between">
      <div>© <span id="year"></span> FMIPA Unsulbar • Sistem Data Prestasi</div>
      <div>Ekspor/Impor JSON/CSV • SPA Offline</div>
    </div>
  </footer>

  <!-- Modal Tambah/Edit Prestasi -->
  <div id="modalForm" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-card w-full max-w-2xl p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 id="modalTitle" class="text-lg font-semibold">Tambah Prestasi</h3>
        <button class="btn" onclick="closeModal('modalForm')">✖</button>
      </div>
      <form id="formPrestasi" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><label class="text-sm font-medium">Kategori <span class="text-red-500">*</span></label>
          <select name="kategori" required class="w-full px-3 py-2 border rounded-xl">
            <option value="">- pilih -</option>
            <option>Mahasiswa</option>
            <option>Dosen</option>
            <option>Tenaga Kependidikan</option>
          </select></div>
        <div><label class="text-sm font-medium">Nama <span class="text-red-500">*</span></label>
          <input name="nama" required class="w-full px-3 py-2 border rounded-xl" placeholder="Nama lengkap"></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Prestasi / Kegiatan <span class="text-red-500">*</span></label>
          <input name="judul" required class="w-full px-3 py-2 border rounded-xl" placeholder="Judul prestasi / lomba / publikasi"></div>
        <div><label class="text-sm font-medium">Tingkat</label>
          <select name="tingkat" class="w-full px-3 py-2 border rounded-xl"><option>Lokal</option><option>Nasional</option><option>Internasional</option></select></div>
        <div><label class="text-sm font-medium">Jurusan</label>
          <select name="jurusan" class="w-full px-3 py-2 border rounded-xl"><option>Matematika</option><option>Bioteknologi</option></select></div>
        <div><label class="text-sm font-medium">Program Studi</label>
          <select name="prodi" class="w-full px-3 py-2 border rounded-xl"><option>Matematika</option><option>Statistika</option><option>Aktuaria</option><option>Bioteknologi</option></select></div>
        <div><label class="text-sm font-medium">Tahun</label>
          <input name="tahun" type="number" min="2000" max="2100" value="2025" class="w-full px-3 py-2 border rounded-xl"></div>
        <div><label class="text-sm font-medium">Tanggal</label>
          <input name="tanggal" type="date" class="w-full px-3 py-2 border rounded-xl"></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Link Sertifikat (URL)</label>
          <input name="linkSertifikat" type="url" placeholder="https://..." class="w-full px-3 py-2 border rounded-xl"></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Unggah Sertifikat (PDF)</label>
          <input name="pdfSertifikat" type="file" accept="application/pdf" class="w-full px-3 py-2 border rounded-xl bg-white">
          <p class="text-xs text-gray-500 mt-1">PDF disimpan lokal (Data URL) dan ikut di ekspor/impor JSON.</p></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Foto Penyerahan Hadiah (JPG/PNG)</label>
          <input name="fotoPenyerahan" type="file" accept="image/*" class="w-full px-3 py-2 border rounded-xl bg-white"></div>
        <div><label class="text-sm font-medium">Status</label>
          <input name="status" value="Menunggu Validasi" readonly class="w-full px-3 py-2 border rounded-xl bg-gray-100"></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Keterangan</label>
          <textarea name="keterangan" rows="3" class="w-full px-3 py-2 border rounded-xl" placeholder="Opsional"></textarea></div>
        <div class="md:col-span-2 flex items-center justify-end gap-2 pt-2">
          <button type="button" class="btn" onclick="closeModal('modalForm')">Batal</button>
          <button type="submit" class="btn primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Tambah Informasi -->
  <div id="modalInfo" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="infoTitle">
    <div class="modal-card w-full max-w-xl p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 id="infoTitle" class="text-lg font-semibold">Tambah Informasi / Pengumuman</h3>
        <button class="btn" onclick="closeModal('modalInfo')">✖</button>
      </div>
      <form id="formInfo" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm font-medium">Tipe</label>
          <select name="tipe" class="w-full px-3 py-2 border rounded-xl">
            <option>Informasi</option>
            <option>Pengumuman</option>
            <option>Beasiswa</option>
            <option>Kegiatan</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium">Tanggal</label>
          <input name="tanggal" type="date" class="w-full px-3 py-2 border rounded-xl">
        </div>
        <div class="md:col-span-2">
          <label class="text-sm font-medium">Judul <span class="text-red-500">*</span></label>
          <input name="judul" required class="w-full px-3 py-2 border rounded-xl" placeholder="Judul singkat">
        </div>
        <div class="md:col-span-2">
          <label class="text-sm font-medium">Isi (ringkas) <span class="text-red-500">*</span></label>
          <textarea name="isi" rows="4" required class="w-full px-3 py-2 border rounded-xl" placeholder="Inti informasi/pengumuman"></textarea>
        </div>
        <div class="md:col-span-2">
          <label class="text-sm font-medium">Tautan (opsional)</label>
          <input name="link" type="url" class="w-full px-3 py-2 border rounded-xl" placeholder="https://...">
        </div>
        <div class="md:col-span-2">
          <label class="text-sm font-medium">Poster/Gambar (opsional)</label>
          <input name="gambar" type="file" accept="image/*" class="w-full px-3 py-2 border rounded-xl bg-white">
          <p class="text-xs text-gray-500 mt-1">Gambar disimpan lokal sebagai Data URL dan ikut diekspor dalam JSON.</p>
        </div>
        <div class="md:col-span-2 flex items-center justify-end gap-2 pt-2">
          <button type="button" class="btn" onclick="closeModal('modalInfo')">Batal</button>
          <button type="submit" class="btn primary">Simpan</button>
        </div>
      </form>
      <p class="text-xs text-gray-600 mt-2">Semua orang di perangkat ini dapat menambahkan informasi (tanpa login).</p>
    </div>
  </div>

  <!-- Modal Login -->
  <div id="modalLogin" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modal-card w-full max-w-sm p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 id="loginTitle" class="text-lg font-semibold">Login Admin</h3>
        <button class="btn" onclick="closeModal('modalLogin')">✖</button>
      </div>
      <form id="formLogin" class="space-y-3">
        <div><label class="text-sm font-medium">Username</label><input name="username" required class="w-full px-3 py-2 border rounded-xl" placeholder="admin"></div>
        <div><label class="text-sm font-medium">Password</label><input name="password" type="password" required class="w-full px-3 py-2 border rounded-xl" placeholder="admin123"></div>
        <div class="flex items-center justify-end gap-2 pt-2">
          <button type="button" class="btn" onclick="closeModal('modalLogin')">Batal</button>
          <button type="submit" class="btn primary">Masuk</button>
        </div>
      </form>
      <p class="text-sm text-gray-600 mt-2">Default: admin / admin123</p>
    </div>
  </div>

  <!-- Modal Ubah Password -->
  <div id="modalPass" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="passTitle">
    <div class="modal-card w-full max-w-sm p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 id="passTitle" class="text-lg font-semibold">Ganti Password</h3>
        <button class="btn" onclick="closeModal('modalPass')">✖</button>
      </div>
      <form id="formPass" class="space-y-3">
        <div><label class="text-sm font-medium">Password Lama</label><input name="old" type="password" required class="w-full px-3 py-2 border rounded-xl"></div>
        <div><label class="text-sm font-medium">Password Baru</label><input name="new1" type="password" minlength="6" required class="w-full px-3 py-2 border rounded-xl"></div>
        <div><label class="text-sm font-medium">Ulangi Password Baru</label><input name="new2" type="password" minlength="6" required class="w-full px-3 py-2 border rounded-xl"></div>
        <div class="flex items-center justify-end gap-2 pt-2">
          <button type="button" class="btn" onclick="closeModal('modalPass')">Batal</button>
          <button type="submit" class="btn primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Edit Akun -->
  <div id="modalEditAkun" class="modal hidden">
    <div class="modal-card w-full max-w-sm p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Edit Akun</h3>
        <button class="btn" onclick="closeModal('modalEditAkun')">✖</button>
      </div>
      <form id="formEditAkun" class="space-y-3">
        <div><label class="text-sm font-medium">Username Baru</label><input name="username" required class="w-full px-3 py-2 border rounded-xl"></div>
        <div class="flex items-center justify-end gap-2 pt-2">
          <button type="button" class="btn" onclick="closeModal('modalEditAkun')">Batal</button>
          <button type="submit" class="btn primary">Simpan</button>
        </div>
      </form>
      <p class="text-xs text-gray-600 mt-2">Mengubah username untuk akun yang sedang login.</p>
    </div>
  </div>

  <!-- Modal Tambah Admin -->
  <div id="modalAddAdmin" class="modal hidden">
    <div class="modal-card w-full max-w-sm p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Tambah Admin</h3>
        <button class="btn" onclick="closeModal('modalAddAdmin')">✖</button>
      </div>
      <form id="formAddAdmin" class="space-y-3">
        <div><label class="text-sm font-medium">Username</label><input name="username" required class="w-full px-3 py-2 border rounded-xl" placeholder="username admin"></div>
        <div><label class="text-sm font-medium">Password</label><input name="password" type="password" minlength="6" required class="w-full px-3 py-2 border rounded-xl" placeholder="min 6 karakter"></div>
        <div class="flex items-center justify-end gap-2 pt-2">
          <button type="button" class="btn" onclick="closeModal('modalAddAdmin')">Batal</button>
          <button type="submit" class="btn primary">Tambah</button>
        </div>
      </form>
      <p class="text-xs text-gray-600 mt-2">Akun baru hanya tersimpan di perangkat ini (tanpa server).</p>
    </div>
  </div>

  <!-- Modal Edit Tentang -->
  <div id="modalTentang" class="modal hidden">
    <div class="modal-card w-full max-w-3xl p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Edit Halaman Tentang</h3>
        <button class="btn" onclick="closeModal('modalTentang')">✖</button>
      </div>
      <textarea id="taTentang" rows="14" class="w-full px-3 py-2 border rounded-xl font-mono text-sm"></textarea>
      <div class="flex items-center justify-end gap-2 pt-3">
        <button class="btn" onclick="closeModal('modalTentang')">Batal</button>
        <button id="btnSaveTentang" class="btn primary">Simpan</button>
      </div>
    </div>
  </div>

  <!-- Templates -->
  <template id="tpl-beranda">
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="card p-4"><div class="text-sm text-gray-600">Total Prestasi</div><div id="cardTotal" class="text-2xl font-semibold mt-1">0</div></div>
      <div class="card p-4"><div class="text-sm text-gray-600">Menunggu Validasi</div><div id="cardPending" class="text-2xl font-semibold mt-1">0</div></div>
      <div class="card p-4"><div class="text-sm text-gray-600">Disetujui</div><div id="cardApproved" class="text-2xl font-semibold mt-1">0</div></div>
      <div class="card p-4"><div class="text-sm text-gray-600">Ditolak</div><div id="cardRejected" class="text-2xl font-semibold mt-1">0</div></div>
    </section>

    <!-- DUA KOLOM: PRESTASI TERBARU (kiri) & INFORMASI TERBARU (kanan) -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div>
        <h3 class="text-lg font-semibold mt-6 mb-3">Prestasi Terbaru</h3>
        <div id="listTerbaru" class="space-y-3"></div>
        <p id="emptyBeranda" class="hidden text-sm text-gray-600">Belum ada data. Tambahkan prestasi melalui tombol di atas atau impor JSON.</p>
      </div>
      <div>
        <h3 class="text-lg font-semibold mt-6 mb-3">Informasi Terbaru</h3>
        <div id="listInfoTerbaru" class="space-y-3"></div>
        <p id="emptyInfoHome" class="hidden text-sm text-gray-600">Belum ada informasi. Tambahkan melalui menu Informasi.</p>
      </div>
    </section>
  </template>

  <template id="tpl-tabel">
    <section>
      <div class="flex flex-wrap items-center gap-2 mb-3">
        <button class="chip" data-chip data-chip-level="All">Semua Tingkat</button>
        <button class="chip" data-chip data-chip-level="Lokal">Lokal</button>
        <button class="chip" data-chip data-chip-level="Nasional">Nasional</button>
        <button class="chip" data-chip data-chip-level="Internasional">Internasional</button>
        <span class="mx-1 text-gray-300">|</span>
        <button class="chip" data-chip data-chip-status="All">Semua Status</button>
        <button class="chip" data-chip data-chip-status="Menunggu Validasi">Menunggu</button>
        <button class="chip" data-chip data-chip-status="Disetujui">Disetujui</button>
        <button class="chip" data-chip data-chip-status="Ditolak">Ditolak</button>
      </div>

      <div class="card p-4">
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 mb-3">
          <select id="filterJurusan" class="px-3 py-2 border rounded-xl"><option value="">Semua Jurusan</option><option>Matematika</option><option>Bioteknologi</option></select>
          <select id="filterProdi" class="px-3 py-2 border rounded-xl"><option value="">Semua Prodi</option><option>Matematika</option><option>Statistika</option><option>Aktuaria</option><option>Bioteknologi</option></select>
          <select id="filterTingkat" class="px-3 py-2 border rounded-xl"><option value="">Semua Tingkat</option><option>Lokal</option><option>Nasional</option><option>Internasional</option></select>
          <select id="filterStatus" class="px-3 py-2 border rounded-xl"><option value="">Semua Status</option><option>Menunggu Validasi</option><option>Disetujui</option><option>Ditolak</option></select>
          <select id="pageSize" class="px-3 py-2 border rounded-xl" title="Baris per halaman"><option>10</option><option selected>15</option><option>25</option><option>50</option></select>
        </div>

        <div class="table-wrap -mx-2 sm:mx-0">
          <div class="min-w-full px-2">
            <table class="table text-sm w-full">
              <thead>
                <tr>
                  <th class="sort" data-sort="tanggal">Tanggal</th>
                  <th class="sort" data-sort="nama">Nama</th>
                  <th class="sort" data-sort="kategori">Kategori</th>
                  <th class="sort" data-sort="judul">Prestasi</th>
                  <th class="sort" data-sort="tingkat">Tingkat</th>
                  <th class="sort" data-sort="jurusan">Jurusan</th>
                  <th class="sort" data-sort="prodi">Prodi</th>
                  <th class="sort" data-sort="tahun">Tahun</th>
                  <th class="sort" data-sort="status">Status</th>
                  <th>Link</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody id="tbodyData"></tbody>
            </table>
          </div>
        </div>

        <div class="flex items-center justify-between mt-3">
          <div id="infoPage" class="text-sm text-gray-600"></div>
          <div class="flex items-center gap-2">
            <button id="prevPage" class="btn">‹</button>
            <span id="pageNow" class="px-2"></span>
            <button id="nextPage" class="btn">›</button>
          </div>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-laporan">
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Toolbar Laporan -->
      <div class="lg:col-span-2 flex items-center justify-between">
        <h3 class="text-lg font-semibold">Laporan Prestasi</h3>
        <button id="btnExportPDFReport" class="btn primary">⤓ Export PDF</button>
      </div>

      <!-- CHARTS PRESTASI -->
      <div class="card p-4">
        <h3 class="text-lg font-semibold mb-3">Rekap per Kategori</h3>
        <div class="relative h-64"><canvas id="chartKategori" class="absolute inset-0 w-full h-full"></canvas></div>
        <div id="chartKategoriFallback" class="hidden text-sm text-gray-600">Grafik fallback (offline).</div>
      </div>
      <div class="card p-4">
        <h3 class="text-lg font-semibold mb-3">Rekap per Tingkat</h3>
        <div class="relative h-64"><canvas id="chartTingkat" class="absolute inset-0 w-full h-full"></canvas></div>
        <div id="chartTingkatFallback" class="hidden text-sm text-gray-600">Grafik fallback (offline).</div>
      </div>
      <div class="card p-4 lg:col-span-2">
        <h3 class="text-lg font-semibold mb-3">Rekap per Tahun</h3>
        <div class="relative h-64"><canvas id="chartTahun" class="absolute inset-0 w-full h-full"></canvas></div>
        <div id="chartTahunFallback" class="hidden text-sm text-gray-600">Grafik fallback (offline).</div>
      </div>
    </section>
  </template>

  <template id="tpl-galeri">
    <section>
      <h3 class="text-lg font-semibold mb-3">Galeri Penyerahan Hadiah</h3>
      <div id="gridGaleri" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4"></div>
      <p id="galeriKosong" class="text-sm text-gray-600 hidden mt-2">Belum ada foto yang diunggah.</p>
    </section>
  </template>

  <!-- HALAMAN INFORMASI & PENGUMUMAN -->
  <template id="tpl-info">
    <section class="card p-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Informasi & Pengumuman</h3>
        <button id="btnAddInfo" class="btn">➕ Tambah</button>
      </div>
      <div class="flex items-center gap-2 mt-3">
        <select id="filterInfoTipe" class="px-3 py-2 border rounded-xl">
          <option value="">Semua Tipe</option>
          <option>Informasi</option>
          <option>Pengumuman</option>
          <option>Beasiswa</option>
          <option>Kegiatan</option>
        </select>
        <input id="searchInfo" type="search" placeholder="Cari…" class="px-3 py-2 border rounded-xl" />
      </div>
      <div id="listInfo" class="space-y-3 mt-3"></div>
      <p id="infoKosong" class="text-sm text-gray-600 hidden">Belum ada informasi.</p>
    </section>
  </template>

  <template id="tpl-tentang">
    <section class="card p-4 space-y-3 leading-relaxed">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Tentang FMIPA Unsulbar</h3>
        <button id="btnEditTentang" class="btn hidden">Edit Tentang</button>
      </div>
      <div id="kontenTentang" class="prose max-w-none"></div>
    </section>
  </template>

  <!-- ===== SCRIPT APP ===== -->
  <script>
/* ===== Memuat Logo ===== */
(function(){
  const el = document.getElementById('logoImg');
  const fav = document.getElementById('favicon');
  const tryLoad = (src) => new Promise(res=>{
    const img = new Image();
    img.onload = ()=> res(src);
    img.onerror = ()=> res(null);
    img.src = src;
  });
  (async ()=>{
    let src = await tryLoad('logo-unsulbar.png');
    if(!src) src = await tryLoad('Logo-Universitas-Sulawesi-Barat.png');
    if(!src){
      src='data:image/svg+xml,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="#24346c"/><circle cx="20" cy="20" r="6" fill="#9a7bff"/><circle cx="44" cy="24" r="5" fill="#6b8cff"/><text x="50%" y="58%" text-anchor="middle" font-family="Arial" font-size="14" fill="white">FMIPA</text></svg>`);
    }
    el.src = src; fav.href = src;
  })();
})();

/* ===== Util ===== */
const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>[...e.querySelectorAll(s)];
const byId=id=>document.getElementById(id);
const STORAGE_KEY='prestasi_fmipa_unsulbar_v4';
const ADMINS_KEY='prestasi_admins_v1';
const SESSION_KEY='prestasi_admin_session_v1';
const TENTANG_KEY='prestasi_tentang_html';
const INFO_KEY='prestasi_info_v1'; // Informasi storage

byId('year').textContent=new Date().getFullYear();
function showToast(msg,type='info',ms=2500){const t=byId('toast');const el=document.createElement('div');el.className='toast-item';el.style.background=type==='error'?'#991b1b':(type==='success'?'#14532d':'#0f172a');el.textContent=msg;t.appendChild(el);setTimeout(()=>el.remove(),ms);}
function openModal(id){byId(id).classList.remove('hidden')}
function closeModal(id){byId(id).classList.add('hidden')}
function uid(){return 'id-'+Math.random().toString(36).slice(2,9)+Date.now().toString(36)}

/* ===== Data (prestasi) ===== */
function loadData(){try{const d=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');return Array.isArray(d)?d:[]}catch{return[]}}
function saveData(d){localStorage.setItem(STORAGE_KEY,JSON.stringify(d))}
let DATA=loadData();

/* ===== Informasi & Pengumuman ===== */
function loadInfo(){try{const d=JSON.parse(localStorage.getItem(INFO_KEY)||'[]');return Array.isArray(d)?d:[]}catch{return[]}}
function saveInfo(d){localStorage.setItem(INFO_KEY,JSON.stringify(d))}
let INFO=loadInfo();

/* ===== Admin multi-user (local) ===== */
function getAdmins(){try{const a=JSON.parse(localStorage.getItem(ADMINS_KEY)||'[]');if(Array.isArray(a) && a.length) return a;}catch{} // seed default
  const def=[{u:'admin',p:'admin123'}]; localStorage.setItem(ADMINS_KEY,JSON.stringify(def)); return def;
}
function setAdmins(a){localStorage.setItem(ADMINS_KEY,JSON.stringify(a))}
function getSession(){try{return JSON.parse(localStorage.getItem(SESSION_KEY)||'null')}catch{return null}}
function setSession(obj){if(obj) localStorage.setItem(SESSION_KEY,JSON.stringify(obj)); else localStorage.removeItem(SESSION_KEY)}
function isAdmin(){return !!getSession()}

function updateAuthUI(){
  const s=getSession();
  // desktop
  byId('btnLogin').classList.toggle('hidden',!!s);
  byId('btnAdminMenu').classList.toggle('hidden',!s);
  // reset hanya admin
  byId('btnReset').classList.toggle('hidden',!s);
  // mobile
  byId('mLogin').classList.toggle('hidden',!!s);
  ['mChangePass','mEditAccount','mAddAdmin','mLogout'].forEach(id=>byId(id).classList.toggle('hidden',!s));
}
updateAuthUI();

/* ===== Navbar: hamburger & link ===== */
const btnHamb = byId('btnHamburger');
const mobileMenu = byId('mobileMenu');
btnHamb.addEventListener('click', ()=>{
  const open = mobileMenu.classList.toggle('hidden') === false;
  btnHamb.setAttribute('aria-expanded', open ? 'true' : 'false');
});
document.addEventListener('click', (e)=>{
  const a = e.target.closest('a.nav-link');
  if(!a) return;
  const href = a.getAttribute('href'); if(!href || !href.startsWith('#/')) return;
  e.preventDefault();
  if(location.hash !== href){ location.hash = href; } else { router(); }
  mobileMenu.classList.add('hidden'); btnHamb.setAttribute('aria-expanded','false');
  window.scrollTo({top:0,behavior:'smooth'});
});

/* ===== Admin dropdown ===== */
const adminMenu = byId('adminMenu');
byId('btnAdminMenu').addEventListener('click', ()=>{
  adminMenu.classList.toggle('hidden');
  const exp=!adminMenu.classList.contains('hidden');
  byId('btnAdminMenu').setAttribute('aria-expanded',exp?'true':'false');
});
document.addEventListener('click',(e)=>{
  if(!e.target.closest('.dropdown')) adminMenu.classList.add('hidden');
});

/* ===== Data dropdown (desktop) ===== */
const dataMenu = byId('dataMenu');
byId('btnDataMenu')?.addEventListener('click', ()=>{
  dataMenu.classList.toggle('hidden');
  const exp = !dataMenu.classList.contains('hidden');
  byId('btnDataMenu').setAttribute('aria-expanded', exp ? 'true' : 'false');
});

/* ===== Data dropdown (mobile) ===== */
byId('mDataToggle')?.addEventListener('click', ()=>{
  byId('mDataMenu').classList.toggle('hidden');
});

/* ===== Login / Logout ===== */
byId('btnLogin').onclick=()=>openModal('modalLogin');
byId('mLogin').onclick=()=>{openModal('modalLogin');mobileMenu.classList.add('hidden')};
byId('miLogout').onclick=logout; byId('mLogout').onclick=logout;
function logout(){ setSession(null); updateAuthUI(); showToast('Logout berhasil','success'); router(); }

byId('formLogin').addEventListener('submit',e=>{
  e.preventDefault();
  const fd=new FormData(e.target); const u=fd.get('username'); const p=fd.get('password');
  const found=getAdmins().find(a=>a.u===u && a.p===p);
  if(found){ setSession({u:found.u}); closeModal('modalLogin'); updateAuthUI(); showToast('Login admin berhasil','success'); }
  else showToast('Username/Password salah','error');
});

/* ===== Ganti password / Edit akun / Tambah admin ===== */
byId('miChangePass').onclick=()=>openModal('modalPass');
byId('mChangePass').onclick=()=>{openModal('modalPass');mobileMenu.classList.add('hidden')};
byId('miEditAccount').onclick=()=>{ const s=getSession(); if(!s) return; byId('formEditAkun').username.value=s.u; openModal('modalEditAkun');}
byId('mEditAccount').onclick=()=>{ const s=getSession(); if(!s) return; byId('formEditAkun').username.value=s.u; openModal('modalEditAkun'); mobileMenu.classList.add('hidden');}
byId('miAddAdmin').onclick=()=>openModal('modalAddAdmin');
byId('mAddAdmin').onclick=()=>{openModal('modalAddAdmin');mobileMenu.classList.add('hidden')};

byId('formPass').addEventListener('submit',e=>{
  e.preventDefault();
  const s=getSession(); if(!s){showToast('Harus login','error');return;}
  const fd=new FormData(e.target); const old=fd.get('old'), n1=fd.get('new1'), n2=fd.get('new2');
  const admins=getAdmins(); const me=admins.find(a=>a.u===s.u);
  if(!me || me.p!==old){ showToast('Password lama salah','error'); return; }
  if(n1.length<6){ showToast('Minimal 6 karakter','error'); return; }
  if(n1!==n2){ showToast('Konfirmasi tidak sama','error'); return; }
  me.p=n1; setAdmins(admins); closeModal('modalPass'); showToast('Password diubah','success');
});

byId('formEditAkun').addEventListener('submit',e=>{
  e.preventDefault();
  const s=getSession(); if(!s){showToast('Harus login','error');return;}
  const fd=new FormData(e.target); const newU=(fd.get('username')||'').trim();
  if(!newU){showToast('Username tidak boleh kosong','error');return;}
  const admins=getAdmins();
  if(admins.some(a=>a.u===newU)){showToast('Username sudah dipakai','error');return;}
  const me=admins.find(a=>a.u===s.u); if(!me){showToast('Akun tidak ditemukan','error');return;}
  me.u=newU; setAdmins(admins); setSession({u:newU}); closeModal('modalEditAkun'); updateAuthUI(); showToast('Username diubah','success');
});

byId('formAddAdmin').addEventListener('submit',e=>{
  e.preventDefault();
  const fd=new FormData(e.target); const u=(fd.get('username')||'').trim(); const p=fd.get('password');
  if(u.length<3){showToast('Username minimal 3 karakter','error');return;}
  if(p.length<6){showToast('Password minimal 6 karakter','error');return;}
  const admins=getAdmins();
  if(admins.some(a=>a.u===u)){showToast('Username sudah ada','error');return;}
  admins.push({u,p}); setAdmins(admins); closeModal('modalAddAdmin'); showToast('Admin baru ditambahkan','success');
});

/* ===== Router ===== */
function setActiveNav(){
  const h = location.hash || '#/beranda';
  $$('#topnav a.nav-link, #mobileMenu a.nav-link').forEach(a=>a.classList.toggle('nav-active', a.getAttribute('href')===h));
}
function router(){
  const h=location.hash||'#/beranda';
  setActiveNav();
  if(h.startsWith('#/beranda')) renderBeranda();
  else if(h.startsWith('#/dosen')) renderTabel('Dosen');
  else if(h.startsWith('#/mahasiswa')) renderTabel('Mahasiswa');
  else if(h.startsWith('#/tendik')) renderTabel('Tenaga Kependidikan');
  else if(h.startsWith('#/laporan')) renderLaporan();
  else if(h.startsWith('#/info')) renderInfo();
  else if(h.startsWith('#/galeri')) renderGaleri();
  else if(h.startsWith('#/tentang')) renderTentang();
  else location.hash='#/beranda';
}
window.addEventListener('hashchange',router);document.addEventListener('DOMContentLoaded',router);

/* ===== Pencarian cepat ===== */
const quickSearch=byId('quickSearch');
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='/'){e.preventDefault();quickSearch.focus();}});
quickSearch.addEventListener('input',()=>render());

/* ===== Ekspor/Impor/Reset ===== */
byId('btnExportCSV').onclick=()=>downloadText('prestasi_fmipa.csv',toCSV(DATA));
byId('btnExportJSON').onclick=()=>downloadText('prestasi_fmipa.json',JSON.stringify(DATA,null,2));
byId('inputImport').addEventListener('change',async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const tx=await f.text(); const j=JSON.parse(tx);
    if(!Array.isArray(j)) throw new Error('Format JSON tidak valid');
    j.forEach(x=>{ if(!x.id) x.id=uid(); if(x.fotoDataURL && x.fotoDataURL.length>1e7) x.fotoDataURL=''; });
    DATA=j; saveData(DATA); showToast('Impor JSON berhasil','success'); render();
  }catch(err){ console.error(err); showToast('Gagal impor JSON','error'); }
  e.target.value='';
});
byId('btnReset').addEventListener('click',()=>{
  if(!isAdmin()){ showToast('Fitur ini hanya untuk admin','error'); return; }
  if(!confirm('Hapus SEMUA data lokal? Tindakan ini tidak bisa dibatalkan.')) return;
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(INFO_KEY);
  DATA=[]; INFO=[];
  showToast('Semua data dihapus','success'); render();
});
function toCSV(arr){const cols=['id','kategori','nama','judul','tingkat','jurusan','prodi','tahun','tanggal','status','keterangan','linkSertifikat'];const lines=[cols.join(',')].concat(arr.map(o=>cols.map(c=>`"${(o[c]??'').toString().replaceAll('"','""')}"`).join(',')));return lines.join('\n')}
function downloadText(fn,txt){const b=new Blob([txt],{type:'text/plain;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=fn;a.click();URL.revokeObjectURL(a.href)}

/* ===== Tambah/Edit Prestasi ===== */
byId('btnAdd').onclick=()=>{ $('#modalTitle').textContent='Tambah Prestasi'; const f=byId('formPrestasi'); f.reset(); f.dataset.editId=''; openModal('modalForm'); }
byId('formPrestasi').addEventListener('submit', async e=>{
  e.preventDefault();
  const f=e.target, fd=new FormData(f), row=Object.fromEntries(fd.entries());
  row.tahun=Number(row.tahun||new Date().getFullYear());
  row.id=f.dataset.editId||uid();
  if(!row.tanggal) row.tanggal=new Date().toISOString().slice(0,10);
  row.linkSertifikat=row.linkSertifikat?.trim()||'';
  const img=f.fotoPenyerahan.files?.[0];
  const pdf=f.pdfSertifikat.files?.[0];
  if(img) row.fotoDataURL=await fileToDataURL(img); else if(!f.dataset.editId) row.fotoDataURL=row.fotoDataURL||'';
  if(pdf) row.pdfDataURL=await fileToDataURL(pdf); else if(!f.dataset.editId) row.pdfDataURL=row.pdfDataURL||'';
  const i=DATA.findIndex(x=>x.id===row.id);
  if(i>=0){ DATA[i]={...DATA[i],...row}; showToast('Data diperbarui','success'); }
  else{ row.status='Menunggu Validasi'; DATA.unshift(row); showToast('Data ditambahkan','success'); }
  saveData(DATA); closeModal('modalForm'); render();
});
function fileToDataURL(file){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(file);});}

/* ===== Render ===== */
function render(){ router(); }

function renderBeranda(){
  const root=byId('app'); root.innerHTML='';
  root.appendChild(byId('tpl-beranda').content.cloneNode(true));

  // Kartu prestasi
  const total=DATA.length,pending=DATA.filter(x=>x.status==='Menunggu Validasi').length,ok=DATA.filter(x=>x.status==='Disetujui').length,no=DATA.filter(x=>x.status==='Ditolak').length;
  byId('cardTotal').textContent=total;byId('cardPending').textContent=pending;byId('cardApproved').textContent=ok;byId('cardRejected').textContent=no;

  // Daftar prestasi terbaru
  const list=byId('listTerbaru');
  if(DATA.length===0) byId('emptyBeranda').classList.remove('hidden');
  DATA.slice(0,5).forEach(x=>{
    const div=document.createElement('div');div.className='card p-3 flex items-start justify-between gap-3';
    div.innerHTML=`<div class="min-w-0">
      <div class="text-sm text-gray-600">${fmtDate(x.tanggal)} • <b>${x.kategori}</b> • ${x.tingkat}</div>
      <div class="font-semibold truncate">${esc(x.judul)}</div>
      <div class="text-sm text-gray-700 truncate">${esc(x.nama)} — ${x.jurusan}/${x.prodi}</div>
    </div>
    <span class="badge ${x.status==='Disetujui'?'ok':x.status==='Ditolak'?'no':'wait'}">${x.status}</span>`;
    list.appendChild(div);
  });

  // Informasi terbaru (kanan)
  const infoListEl = byId('listInfoTerbaru');
  const infoEmpty = byId('emptyInfoHome');
  if(!INFO.length){ infoEmpty.classList.remove('hidden'); }
  else{
    infoEmpty.classList.add('hidden');
    INFO.slice().sort((a,b)=>new Date(b.tanggal)-new Date(a.tanggal)).slice(0,5).forEach(x=>{
      const wrap=document.createElement('div');
      wrap.className='card p-3 flex items-start gap-3';
      wrap.innerHTML = `
        ${x.imgDataURL ? `<img src="${x.imgDataURL}" alt="poster" class="w-16 h-16 rounded-lg object-cover border">` : ''}
        <div class="min-w-0">
          <div class="text-sm text-gray-600">${fmtDate(x.tanggal)} • <span class="chip">${esc(x.tipe)}</span></div>
          <div class="font-semibold truncate">${esc(x.judul)}</div>
          <div class="text-sm text-gray-700 truncate">${esc(x.isi)}</div>
          ${x.link ? `<a href="${esc(x.link)}" target="_blank" rel="noopener" class="text-xs underline underline-offset-4 text-brand-700">Tautan</a>` : ''}
        </div>
      `;
      infoListEl.appendChild(wrap);
    });
  }
}

function renderTabel(forKategori){
  const root=byId('app'); root.innerHTML=''; root.appendChild(byId('tpl-tabel').content.cloneNode(true));
  let state={sortBy:'tanggal',sortDir:'desc',page:1,pageSize:Number(byId('pageSize').value||15),filterJurusan:'',filterProdi:'',filterTingkat:'',filterStatus:'',chipLevel:'All',chipStatus:'All'};
  byId('pageSize').onchange=e=>{state.pageSize=Number(e.target.value);state.page=1;paint()}
  byId('filterJurusan').onchange=e=>{state.filterJurusan=e.target.value;state.page=1;paint()}
  byId('filterProdi').onchange=e=>{state.filterProdi=e.target.value;state.page=1;paint()}
  byId('filterTingkat').onchange=e=>{state.filterTingkat=e.target.value;state.page=1;paint()}
  byId('filterStatus').onchange=e=>{state.filterStatus=e.target.value;state.page=1;paint()}
  byId('prevPage').onclick=()=>{if(state.page>1){state.page-- ;paint()}}
  byId('nextPage').onclick=()=>{state.page++ ;paint()}
  $$('.sort').forEach(th=>th.onclick=()=>{const k=th.dataset.sort;if(state.sortBy===k) state.sortDir=state.sortDir==='asc'?'desc':'asc'; else{state.sortBy=k;state.sortDir='asc';}paint()});
  $$('[data-chip]').forEach(ch=>ch.onclick=()=>{const lvl=ch.dataset.chipLevel,st=ch.dataset.chipStatus;if(lvl){state.chipLevel=lvl;$$('[data-chip][data-chip-level]').forEach(c=>c.classList.remove('active'));ch.classList.add('active');} if(st){state.chipStatus=st;$$('[data-chip][data-chip-status]').forEach(c=>c.classList.remove('active'));ch.classList.add('active');} state.page=1;paint()});

  function filtered(){
    const q=quickSearch.value.trim().toLowerCase();
    return DATA.filter(x=>{
      if(x.kategori!==forKategori) return false;
      if(state.filterJurusan && x.jurusan!==state.filterJurusan) return false;
      if(state.filterProdi && x.prodi!==state.filterProdi) return false;
      if(state.filterTingkat && x.tingkat!==state.filterTingkat) return false;
      if(state.filterStatus && x.status!==state.filterStatus) return false;
      if(state.chipLevel!=='All' && x.tingkat!==state.chipLevel) return false;
      if(state.chipStatus!=='All' && x.status!==state.chipStatus) return false;
      if(q){const hay=`${x.nama} ${x.judul} ${x.jurusan} ${x.prodi} ${x.tingkat} ${x.status}`.toLowerCase(); if(!hay.includes(q)) return false;}
      return true;
    });
  }
  function sorter(a,b,k){const d=state.sortDir==='asc'?1:-1;let va=a[k],vb=b[k]; if(k==='tahun'){va=Number(va||0);vb=Number(vb||0);} if(k==='tanggal'){va=new Date(a.tanggal||'1970-01-01');vb=new Date(b.tanggal||'1970-01-01');} if(va<vb)return-1*d; if(va>vb)return 1*d; return 0;}
  function paint(){
    const arr=filtered().sort((a,b)=>sorter(a,b,state.sortBy));
    const total=arr.length,start=(state.page-1)*state.pageSize,pageItems=arr.slice(start,start+state.pageSize);
    if(start>=total&&state.page>1){state.page=Math.max(1,Math.ceil(total/state.pageSize));return paint();}
    const tbody=byId('tbodyData'); tbody.innerHTML='';
    pageItems.forEach(x=>{
      const tr=document.createElement('tr'); tr.innerHTML=`
        <td>${fmtDate(x.tanggal)}</td>
        <td class="font-medium">${esc(x.nama)}</td>
        <td>${x.kategori}</td>
        <td class="min-w-[16rem]">${esc(x.judul)}</td>
        <td>${x.tingkat}</td>
        <td>${x.jurusan}</td>
        <td>${x.prodi}</td>
        <td>${x.tahun}</td>
        <td><span class="badge ${x.status==='Disetujui'?'ok':x.status==='Ditolak'?'no':'wait'}">${x.status}</span></td>
        <td>
          ${x.linkSertifikat?`<a href="${esc(x.linkSertifikat)}" target="_blank" rel="noopener" class="underline underline-offset-4 text-brand-700">Sertifikat</a>`:''}
          ${x.pdfDataURL?`${x.linkSertifikat?' • ':''}<a href="${x.pdfDataURL}" target="_blank" rel="noopener" class="underline underline-offset-4 text-brand-700">PDF</a>`:''}
          ${(!x.linkSertifikat && !x.pdfDataURL)?'<span class="text-gray-400">-</span>':''}
          ${x.fotoDataURL?' • <a href="#/galeri" class="underline underline-offset-4 text-brand-700">Foto</a>':''}
        </td>
        <td class="whitespace-nowrap">
          ${isAdmin()? `<div class="flex items-center gap-2">
            <button class="btn primary" title="Setujui" data-approve="${x.id}">✔</button>
            <button class="btn warn" title="Tolak" data-reject="${x.id}">✖</button>
            <button class="btn" title="Edit" data-edit="${x.id}">✎</button>
            <button class="btn danger" title="Hapus" data-del="${x.id}">🗑</button>
          </div>` : `<span class="text-xs text-gray-500">Login admin untuk tindakan</span>`}
        </td>`;
      tbody.appendChild(tr);
    });
    if(isAdmin()){
      $$('[data-approve]').forEach(b=>b.onclick=()=>updateStatus(b.dataset.approve,'Disetujui'));
      $$('[data-reject]').forEach(b=>b.onclick=()=>updateStatus(b.dataset.reject,'Ditolak'));
      $$('[data-del]').forEach(b=>b.onclick=()=>delRow(b.dataset.del));
      $$('[data-edit]').forEach(b=>b.onclick=()=>editRow(b.dataset.edit));
    }
    byId('infoPage').textContent=`${total} data • Urut: ${state.sortBy} (${state.sortDir})`;
    byId('pageNow').textContent=`${state.page} / ${Math.max(1,Math.ceil(total/state.pageSize))}`;
  }
  paint();

  function updateStatus(id,st){const i=DATA.findIndex(x=>x.id===id); if(i<0)return; DATA[i].status=st; saveData(DATA); showToast(`Status diubah ke ${st}`,'success'); paint();}
  function delRow(id){ if(!confirm('Hapus data ini?')) return; DATA=DATA.filter(x=>x.id!==id); saveData(DATA); showToast('Data dihapus','success'); paint();}
  function editRow(id){
    const x=DATA.find(r=>r.id===id); if(!x)return;
    $('#modalTitle').textContent='Edit Prestasi';
    const f=byId('formPrestasi'); f.reset(); f.dataset.editId=x.id;
    f.kategori.value=x.kategori; f.nama.value=x.nama; f.judul.value=x.judul; f.tingkat.value=x.tingkat;
    f.jurusan.value=x.jurusan; f.prodi.value=x.prodi; f.tahun.value=x.tahun; f.tanggal.value=x.tanggal;
    f.status.value=x.status; f.keterangan.value=x.keterangan||''; f.linkSertifikat.value=x.linkSertifikat||'';
    openModal('modalForm');
  }
}

function renderLaporan(){
  const root=byId('app'); root.innerHTML='';
  root.appendChild(byId('tpl-laporan').content.cloneNode(true));

  // Tombol Export PDF
  byId('btnExportPDFReport').onclick = exportReportPDF;

  // ====== CHARTS ======
  const cat=groupCount(DATA,'kategori'), lvl=groupCount(DATA,'tingkat'), th=groupCount(DATA,'tahun');
  makeChartOrFallback('chartKategori','chartKategoriFallback','pie',Object.keys(cat),Object.values(cat));
  makeChartOrFallback('chartTingkat','chartTingkatFallback','bar',Object.keys(lvl),Object.values(lvl));
  const years=Object.keys(th).sort((a,b)=>a-b); makeChartOrFallback('chartTahun','chartTahunFallback','line',years,years.map(y=>th[y]));
}

function renderGaleri(){
  const root=byId('app'); root.innerHTML=''; root.appendChild(byId('tpl-galeri').content.cloneNode(true));
  const grid=byId('gridGaleri'); grid.innerHTML='';
  const fotos=DATA.filter(x=>x.fotoDataURL);
  if(!fotos.length){ byId('galeriKosong').classList.remove('hidden'); return; }
  fotos.forEach(x=>{
    const card=document.createElement('div'); card.className='card p-2';
    card.innerHTML=`<img src="${x.fotoDataURL}" alt="Foto ${esc(x.nama)}" class="w-full h-40 object-cover rounded-xl">
      <div class="p-2">
        <div class="font-semibold text-sm truncate">${esc(x.nama)} • ${x.kategori}</div>
        <div class="text-xs text-gray-600 truncate">${esc(x.judul)}</div>
        <div class="text-xs text-gray-500">${fmtDate(x.tanggal)} • ${x.tingkat}</div>
        ${x.linkSertifikat?`<a href="${esc(x.linkSertifikat)}" target="_blank" rel="noopener" class="text-xs underline underline-offset-4 text-brand-700">Sertifikat</a>`:''}
        ${x.pdfDataURL?` • <a href="${x.pdfDataURL}" target="_blank" rel="noopener" class="text-xs underline underline-offset-4 text-brand-700">PDF</a>`:''}
      </div>`;
    card.onclick=()=>lightbox(x.fotoDataURL, `${esc(x.nama)} — ${esc(x.judul)}`);
    grid.appendChild(card);
  });
}
function lightbox(src,cap=''){const wrap=document.createElement('div');wrap.className='modal';wrap.innerHTML=`<div class="modal-card w-full max-w-4xl p-2"><img src="${src}" alt="${cap}" class="w-full max-h-[75vh] object-contain rounded-xl"><div class="p-2 text-sm text-gray-600">${cap}</div><div class="flex justify-end"><button class="btn">Tutup</button></div></div>`;wrap.querySelector('button').onclick=()=>wrap.remove();wrap.addEventListener('click',e=>{if(e.target===wrap)wrap.remove()});document.body.appendChild(wrap);}

/* ===== Halaman Informasi ===== */
function renderInfo(){
  const root=byId('app'); root.innerHTML='';
  root.appendChild(byId('tpl-info').content.cloneNode(true));
  const list=byId('listInfo');
  const empty=byId('infoKosong');
  const selTipe=byId('filterInfoTipe');
  const q=byId('searchInfo');

  byId('btnAddInfo').onclick=()=>{
    const f=byId('formInfo');
    f.reset();
    f.tanggal.value = new Date().toISOString().slice(0,10);
    openModal('modalInfo');
  };

  byId('formInfo').onsubmit=async (e)=>{
    e.preventDefault();
    const f=e.target;
    const fd=new FormData(f);
    const rec = Object.fromEntries(fd.entries());
    rec.id = uid();
    rec.judul = (rec.judul||'').trim();
    rec.isi = (rec.isi||'').trim();
    rec.tipe = rec.tipe || 'Informasi';
    rec.tanggal = rec.tanggal || new Date().toISOString().slice(0,10);
    rec.link = (rec.link||'').trim();

    const img=f.gambar.files?.[0];
    if(img){
      if(img.size > 5*1024*1024){ showToast('Gambar >5MB, harap perkecil','error'); return; }
      rec.imgDataURL = await fileToDataURL(img);
    } else {
      rec.imgDataURL = rec.imgDataURL || '';
    }

    if(!rec.judul || !rec.isi){ showToast('Judul dan isi wajib diisi','error'); return; }
    if(rec.link && !/^https?:\/\//i.test(rec.link)){ showToast('Link harus diawali http/https','error'); return; }

    INFO.unshift(rec);
    saveInfo(INFO);
    closeModal('modalInfo');
    showToast('Informasi ditambahkan','success');
    paint();
  };

  selTipe.onchange=paint;
  q.oninput=()=>{ paint(); };

  function paint(){
    list.innerHTML='';
    let data = INFO.slice().sort((a,b)=>new Date(b.tanggal)-new Date(a.tanggal));
    const tipe = selTipe.value;
    const query = q.value.trim().toLowerCase();
    if(tipe) data = data.filter(x=>x.tipe===tipe);
    if(query) data = data.filter(x=>`${x.judul} ${x.isi}`.toLowerCase().includes(query));

    if(!data.length){ empty.classList.remove('hidden'); return; }
    empty.classList.add('hidden');

    const now = new Date();
    data.forEach(x=>{
      const isNew = (now - new Date(x.tanggal)) / (1000*60*60*24) <= 7;
      const item=document.createElement('div');
      item.className='p-3 border rounded-xl bg-white shadow-soft';
      item.innerHTML = `
        <div class="flex items-start gap-3">
          ${x.imgDataURL ? `<img src="${x.imgDataURL}" alt="poster" class="w-20 h-20 rounded-lg object-cover border flex-none">` : ''}
          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-2 text-sm text-gray-600">
              <span>${fmtDate(x.tanggal)}</span>
              <span class="chip">${esc(x.tipe)}</span>
              ${isNew ? '<span class="badge ok">NEW</span>' : ''}
            </div>
            <div class="font-semibold">${esc(x.judul)}</div>
            <div class="text-sm text-gray-700 whitespace-pre-wrap">${esc(x.isi)}</div>
            ${x.link ? `<a href="${esc(x.link)}" target="_blank" rel="noopener" class="text-sm underline underline-offset-4 text-brand-700 mt-1 inline-block">Buka tautan</a>` : ''}
          </div>
        </div>
      `;
      list.appendChild(item);
    });
  }

  paint();
}

/* ===== Tentang ===== */
function renderTentang(){
  const root=byId('app'); root.innerHTML=''; root.appendChild(byId('tpl-tentang').content.cloneNode(true));
  const defHTML = `
    <p>FMIPA Universitas Sulawesi Barat berkomitmen pada pengembangan sains dan teknologi yang berdampak.
    Sistem ini mendukung transparansi dan akuntabilitas prestasi sivitas akademika.</p>
    <h4 class="text-base font-semibold mt-4">Struktur Jurusan & Program Studi</h4>
    <ul class="list-disc pl-6">
      <li><b>Jurusan Matematika</b>: Program Studi <i>Matematika</i>, <i>Statistika</i>, <i>Aktuaria</i>.</li>
      <li><b>Jurusan Bioteknologi</b>: Program Studi <i>Bioteknologi</i>.</li>
    </ul>`;
  const html = localStorage.getItem(TENTANG_KEY) || defHTML;
  byId('kontenTentang').innerHTML = html;
  const s=getSession();
  if(s) byId('btnEditTentang').classList.remove('hidden');
  byId('btnEditTentang')?.addEventListener('click',()=>{
    byId('taTentang').value = localStorage.getItem(TENTANG_KEY) || defHTML;
    openModal('modalTentang');
  });
  byId('btnSaveTentang').onclick=()=>{ localStorage.setItem(TENTANG_KEY, byId('taTentang').value); closeModal('modalTentang'); showToast('Halaman Tentang diperbarui','success'); renderTentang(); };
}

/* ===== Export PDF Laporan ===== */
async function exportReportPDF(){
  const total=DATA.length, pending=DATA.filter(x=>x.status==='Menunggu Validasi').length, ok=DATA.filter(x=>x.status==='Disetujui').length, no=DATA.filter(x=>x.status==='Ditolak').length;

  const cKat = byId('chartKategori');
  const cTkt = byId('chartTingkat');
  const cThn = byId('chartTahun');
  const imgKat = cKat ? cKat.toDataURL('image/jpeg',0.92) : null;
  const imgTkt = cTkt ? cTkt.toDataURL('image/jpeg',0.92) : null;
  const imgThn = cThn ? cThn.toDataURL('image/jpeg',0.92) : null;

  // Fallback: jika jsPDF tidak tersedia (offline) -> open print
  if(window.__pdfOffline || !window.jspdf || !window.jspdf.jsPDF){
    const w = window.open('', '_blank');
    const today = new Date().toLocaleString('id-ID');
    w.document.write(`
      <html><head><title>Laporan Prestasi - ${today}</title>
      <style>
        body{font-family:Arial, sans-serif; padding:24px;}
        h1{margin:0 0 8px 0;}
        .muted{color:#555}
        .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:16px 0 24px}
        .card{border:1px solid #ddd;border-radius:8px;padding:12px}
        .img{margin:16px 0;border:1px solid #eee;border-radius:8px;padding:8px;text-align:center}
        img{max-width:100%}
      </style></head><body>
      <h1>Laporan Prestasi FMIPA Unsulbar</h1>
      <div class="muted">${today}</div>
      <div class="grid">
        <div class="card"><div>Total Prestasi</div><h2>${total}</h2></div>
        <div class="card"><div>Menunggu</div><h2>${pending}</h2></div>
        <div class="card"><div>Disetujui</div><h2>${ok}</h2></div>
        <div class="card"><div>Ditolak</div><h2>${no}</h2></div>
      </div>
      ${imgKat?`<div class="img"><h3>Rekap per Kategori</h3><img src="${imgKat}"></div>`:''}
      ${imgTkt?`<div class="img"><h3>Rekap per Tingkat</h3><img src="${imgTkt}"></div>`:''}
      ${imgThn?`<div class="img"><h3>Rekap per Tahun</h3><img src="${imgThn}"></div>`:''}
      <script>window.onload=()=>{window.print();}<\/script>
      </body></html>
    `);
    w.document.close();
    return;
  }

  // Dengan jsPDF
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','mm','a4');
  const pageW = 210, pageH = 297, margin = 12;

  const today = new Date().toLocaleString('id-ID');
  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text('Laporan Prestasi FMIPA Unsulbar', margin, 20);
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text(today, margin, 26);

  // Ringkasan angka
  doc.setFontSize(12); doc.setFont('helvetica','bold');
  doc.text('Ringkasan', margin, 38);
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  const lines = [
    `Total Prestasi   : ${total}`,
    `Menunggu Validasi: ${pending}`,
    `Disetujui        : ${ok}`,
    `Ditolak          : ${no}`
  ];
  lines.forEach((t,i)=> doc.text(t, margin, 48 + i*6));

  function addChart(img, title, startY){
    if(!img) return startY;
    const maxW = pageW - margin*2;
    const imgW = maxW, imgH = imgW * 0.55;
    if(startY + 10 + imgH > pageH - margin){ doc.addPage(); startY = margin; }
    doc.setFont('helvetica','bold'); doc.setFontSize(12);
    doc.text(title, margin, startY + 6);
    doc.addImage(img, 'JPEG', margin, startY + 10, imgW, imgH, undefined, 'FAST');
    return startY + 10 + imgH + 8;
  }

  let y = 48 + lines.length*6 + 6;
  y = addChart(imgKat, 'Rekap per Kategori', y);
  y = addChart(imgTkt, 'Rekap per Tingkat', y);
  y = addChart(imgThn, 'Rekap per Tahun', y);

  doc.save(`Laporan-Prestasi-FMIPA-${new Date().toISOString().slice(0,10)}.pdf`);
  showToast('PDF laporan berhasil dibuat','success');
}

/* ===== Helpers & Charts (fallback) ===== */
function esc(s=''){return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function fmtDate(d){if(!d)return'-';const dd=new Date(d);if(isNaN(dd))return d;return dd.toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'});}
function groupCount(a,k){return a.reduce((m,c)=>(m[c[k]]=(m[c[k]]||0)+1,m),{});}
function makeChartOrFallback(id,fid,type,labels,data){
  const ctx=byId(id).getContext('2d');
  if(window.__chartOffline||typeof Chart==='undefined'){
    byId(fid).classList.remove('hidden');
    if(type==='pie')drawFallbackPie(ctx,labels,data); else if(type==='line')drawFallbackLine(ctx,labels,data); else drawFallbackBar(ctx,labels,data);
  } else {
    const optsCommon={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:type!=='bar'}}};
    const ds = type==='pie' ? [{data,backgroundColor:['#22c55e','#3b82f6','#f59e0b']}] : [{label:'Jumlah',data,backgroundColor:'#6b8cff'}];
    new Chart(ctx,{type,data:{labels,datasets:ds},options:optsCommon});
  }
}
function drawFallbackBar(ctx,labels,data){const W=ctx.canvas.width,H=ctx.canvas.height,max=Math.max(1,...data),p=20,g=10,n=labels.length,bw=(W-p*2-g*(n-1))/n;const c=ctx;c.clearRect(0,0,W,H);c.fillStyle='#6b8cff';labels.forEach((lb,i)=>{const h=(H-p*2)*(data[i]/max);const x=p+i*(bw+g),y=H-p-h;c.fillRect(x,y,bw,h);});}
function drawFallbackPie(ctx,labels,data){const W=ctx.canvas.width,H=ctx.canvas.height,r=Math.min(W,H)/2-10,cx=W/2,cy=H/2,total=data.reduce((a,b)=>a+b,0)||1,c=ctx;c.clearRect(0,0,W,H);let st=0;['#22c55e','#3b82f6','#f59e0b'].forEach((col,i)=>{const v=data[i]??0;const ang=(v/total)*Math.PI*2;c.beginPath();c.moveTo(cx,cy);c.fillStyle=col;c.arc(cx,cy,r,st,st+ang);c.closePath();c.fill();st+=ang;});}
function drawFallbackLine(ctx,labels,data){const W=ctx.canvas.width,H=ctx.canvas.height,p=20,max=Math.max(1,...data),min=0,n=labels.length,c=ctx;c.clearRect(0,0,W,H);c.strokeStyle='#6b8cff';c.lineWidth=2;c.beginPath();labels.forEach((lb,i)=>{const x=p+i*((W-2*p)/Math.max(1,n-1)),y=H-p-((data[i]-min)/(max-min))*(H-2*p);if(i===0)c.moveTo(x,y);else c.lineTo(x,y);});c.stroke();}

/* ===== UX kecil: ESC untuk menutup modal ===== */
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ $$('.modal').forEach(m=>m.classList.add('hidden')); } });

/* ===== Inisialisasi ===== */
router();
  </script>
</body>
</html>
