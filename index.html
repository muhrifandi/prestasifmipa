<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistem Data Prestasi | FMIPA Unsulbar</title>
  <meta name="description" content="Sistem Data Prestasi FMIPA Unsulbar - SPA Supabase">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--brand1:#5a79f0;--brand2:#2f3ea8}
    .brand-hero{background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#fff}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.55rem .9rem;border-radius:.8rem;border:1px solid #e5e7eb;background:#fff}
    .btn.primary{background:var(--brand1);color:#fff;border-color:transparent}
    .btn.light{background:#fff;color:#1f2a69;border:1px solid rgba(255,255,255,.6)}
    .btn.danger{background:#ef4444;color:#fff;border-color:transparent}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:1rem;box-shadow:0 8px 30px rgba(31,41,55,.06)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:100}
    .toast{position:fixed;right:1rem;bottom:1rem;display:flex;flex-direction:column;gap:.5rem;z-index:200}
    .toast-item{background:#0f172a;color:#fff;padding:.7rem 1rem;border-radius:.7rem;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    a.nav{padding:.5rem .75rem;border-radius:.5rem}
    a.nav.active, a.nav:hover{background:#eef2ff}
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <div id="toast" class="toast"></div>

  <!-- Header / NAVBAR -->
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-center justify-between py-3">
        <div class="flex items-center gap-3 min-w-0">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-indigo-700 grid place-items-center text-white font-bold">FM</div>
          <div class="truncate">
            <h1 class="text-lg font-semibold">Sistem Data Prestasi <span class="text-indigo-700">FMIPA</span></h1>
            <p class="text-sm text-gray-600">Universitas Sulawesi Barat</p>
          </div>
        </div>
        <nav class="hidden md:flex items-center gap-1">
          <a href="#/beranda" class="nav">Beranda</a>
          <a href="#/prestasi" class="nav">Prestasi</a>
          <a href="#/kelola-registrasi" id="navKelolaReg" class="nav hidden">Kelola Pendaftar</a>
          <span class="mx-2 text-gray-300">|</span>
          <button id="btnLogin" class="btn primary">Masuk</button>
          <button id="btnLoginNIM" class="btn">Masuk NIM/NIDN/NIP</button>
          <button id="btnLogout" class="btn hidden">Logout</button>
        </nav>
        <button id="btnHamburger" class="btn md:hidden" aria-label="Buka menu" aria-expanded="false">☰</button>
      </div>
      <!-- Mobile menu -->
      <div id="mobileMenu" class="md:hidden hidden pb-3">
        <div class="flex flex-col gap-1">
          <a href="#/beranda" class="px-3 py-2 rounded hover:bg-indigo-50">Beranda</a>
          <a href="#/prestasi" class="px-3 py-2 rounded hover:bg-indigo-50">Prestasi</a>
          <a href="#/kelola-registrasi" id="navKelolaRegMobile" class="px-3 py-2 rounded hover:bg-indigo-50 hidden">Kelola Pendaftar</a>
          <div class="flex gap-2 px-3 mt-2">
            <button id="btnLoginMobile" class="btn primary w-full">Masuk</button>
            <button id="btnLoginNIMMobile" class="btn w-full">Masuk NIM/NIDN/NIP</button>
            <button id="btnLogoutMobile" class="btn w-full hidden">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Toolbar -->
  <div class="border-b border-gray-200 bg-white">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center gap-2 justify-between">
      <div class="flex items-center gap-2">
        <button id="btnAdd" class="btn primary hidden">➕ Tambah Prestasi</button>
        <button id="btnExportCSV" class="btn hidden">↓ CSV</button>
      </div>
      <input id="quickSearch" type="search" placeholder="Cari cepat…" class="w-44 sm:w-64 md:w-80 px-3 py-2 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" />
    </div>
  </div>

  <!-- Root -->
  <main id="app" class="max-w-7xl mx-auto px-4 py-6 space-y-6"></main>

  <footer class="mt-10 border-t border-gray-200 py-6 text-sm text-gray-600">
    <div class="max-w-7xl mx-auto px-4 flex items-center justify-between">
      <div>© <span id="year"></span> FMIPA Unsulbar • Sistem Data Prestasi</div>
      <div>Powered by Supabase</div>
    </div>
  </footer>

  <!-- ======= MODALS ======= -->

  <!-- Modal Masuk (email+password) -->
  <div id="modalLogin" class="modal hidden">
    <div class="modal-card w-full max-w-lg p-4 card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Masuk</h3>
        <button class="btn" onclick="closeModal('modalLogin')">✖</button>
      </div>
      <form id="formLogin" class="space-y-3">
        <div>
          <label class="text-sm font-medium">Email</label>
          <input name="email" type="email" required class="w-full px-3 py-2 border rounded-xl" placeholder="nama@unsulbar.ac.id">
        </div>
        <div>
          <label class="text-sm font-medium">Password</label>
          <input name="password" type="password" required class="w-full px-3 py-2 border rounded-xl" placeholder="••••••••">
        </div>
        <div class="flex items-center justify-between pt-2">
          <button type="button" class="btn" onclick="closeModal('modalLogin')">Batal</button>
          <div class="text-sm text-gray-600">
            Belum punya akun? <a id="linkOpenSignup" class="underline cursor-pointer">Daftar</a>
          </div>
          <button type="submit" class="btn primary">Masuk</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Daftar (email+password) -->
  <div id="modalSignup" class="modal hidden">
    <div class="modal-card w-full max-w-lg p-4 card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Daftar Akun</h3>
        <button class="btn" onclick="closeModal('modalSignup')">✖</button>
      </div>
      <form id="formSignup" class="space-y-3">
        <div>
          <label class="text-sm font-medium">Email</label>
          <input name="email" type="email" required class="w-full px-3 py-2 border rounded-xl" placeholder="nama@unsulbar.ac.id">
        </div>
        <div>
          <label class="text-sm font-medium">Password</label>
          <input name="password" type="password" minlength="6" required class="w-full px-3 py-2 border rounded-xl" placeholder="min 6 karakter">
        </div>
        <div class="flex items-center justify-end gap-2 pt-2">
          <button type="button" class="btn" onclick="closeModal('modalSignup')">Batal</button>
          <button type="submit" class="btn primary">Daftar</button>
        </div>
      </form>
      <p class="text-xs text-gray-600 mt-2">Setelah daftar, silakan login untuk menambahkan prestasi.</p>
    </div>
  </div>

  <!-- Modal Login NIM/NIDN/NIP -->
  <div id="modalLoginNIM" class="modal hidden">
    <div class="modal-card w-full max-w-lg p-4 card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Masuk dengan NIM/NIDN/NIP</h3>
        <button class="btn" onclick="closeModal('modalLoginNIM')">✖</button>
      </div>
      <form id="formLoginNIM" class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm font-medium">Jenis</label>
            <select name="jenis" class="w-full px-3 py-2 border rounded-xl">
              <option value="NIM">NIM</option>
              <option value="NIDN">NIDN</option>
              <option value="NIP">NIP</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium">Nomor</label>
            <input name="nomor" required class="w-full px-3 py-2 border rounded-xl" placeholder="Hanya angka">
          </div>
        </div>
        <p class="text-xs text-gray-600">Jika pendaftaran Anda <b>disetujui</b>, kami akan mengirim <i>magic link</i> ke email yang terdaftar.</p>
        <div class="flex items-center justify-end gap-2 pt-2">
          <button type="button" class="btn" onclick="closeModal('modalLoginNIM')">Batal</button>
          <button type="submit" class="btn primary">Kirim Link Masuk</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Daftar Registrasi (NIM/NIDN/NIP) -->
  <div id="modalRegister" class="modal hidden">
    <div class="modal-card w-full max-w-lg p-4 card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Daftar Registrasi Sivitas</h3>
        <button class="btn" onclick="closeModal('modalRegister')">✖</button>
      </div>
      <form id="formRegister" class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm font-medium">Jenis</label>
            <select name="jenis" class="w-full px-3 py-2 border rounded-xl">
              <option>NIM</option><option>NIDN</option><option>NIP</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium">Nomor (angka)</label>
            <input name="nomor" required class="w-full px-3 py-2 border rounded-xl" placeholder="contoh: 2201...">
          </div>
        </div>
        <div>
          <label class="text-sm font-medium">Nama Lengkap</label>
          <input name="nama" required class="w-full px-3 py-2 border rounded-xl">
        </div>
        <div>
          <label class="text-sm font-medium">Email (wajib untuk login)</label>
          <input name="email" type="email" required class="w-full px-3 py-2 border rounded-xl" placeholder="nama@unsulbar.ac.id">
        </div>
        <p class="text-xs text-gray-600">Pendaftaran akan <b>diverifikasi admin</b> sebelum Anda dapat menambah prestasi atau login via NIM/NIDN/NIP.</p>
        <div class="flex items-center justify-end gap-2 pt-2">
          <button type="button" class="btn" onclick="closeModal('modalRegister')">Batal</button>
          <button type="submit" class="btn primary">Kirim Pendaftaran</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Tambah/Edit Prestasi -->
  <div id="modalForm" class="modal hidden">
    <div class="modal-card w-full max-w-2xl p-4 card">
      <div class="flex items-center justify-between mb-3">
        <h3 id="modalTitle" class="text-lg font-semibold">Tambah Prestasi</h3>
        <button class="btn" onclick="closeModal('modalForm')">✖</button>
      </div>
      <form id="formPrestasi" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><label class="text-sm font-medium">Kategori</label>
          <select name="kategori" required class="w-full px-3 py-2 border rounded-xl">
            <option>Mahasiswa</option><option>Dosen</option><option>Tenaga Kependidikan</option>
          </select></div>
        <div><label class="text-sm font-medium">Nama</label>
          <input name="nama" required class="w-full px-3 py-2 border rounded-xl" placeholder="Nama lengkap"></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Prestasi / Kegiatan</label>
          <input name="judul" required class="w-full px-3 py-2 border rounded-xl" placeholder="Judul prestasi / lomba / publikasi"></div>
        <div><label class="text-sm font-medium">Tingkat</label>
          <select name="tingkat" class="w-full px-3 py-2 border rounded-xl">
            <option>Universitas</option><option>Kabupaten</option><option>Provinsi</option>
            <option>Regional</option><option>Nasional</option><option>Internasional</option>
          </select></div>
        <div><label class="text-sm font-medium">Jurusan</label>
          <select name="jurusan" class="w-full px-3 py-2 border rounded-xl"><option>Matematika</option><option>Bioteknologi</option></select></div>
        <div><label class="text-sm font-medium">Program Studi</label>
          <select name="prodi" class="w-full px-3 py-2 border rounded-xl"><option>Matematika</option><option>Statistika</option><option>Aktuaria</option><option>Bioteknologi</option></select></div>
        <div><label class="text-sm font-medium">Tahun</label>
          <input name="tahun" type="number" min="2000" max="2100" value="2025" class="w-full px-3 py-2 border rounded-xl"></div>
        <div><label class="text-sm font-medium">Tanggal</label>
          <input name="tanggal" type="date" class="w-full px-3 py-2 border rounded-xl"></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Link Sertifikat (URL)</label>
          <input name="linkSertifikat" type="url" placeholder="https://..." class="w-full px-3 py-2 border rounded-xl"></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Keterangan</label>
          <textarea name="keterangan" rows="3" class="w-full px-3 py-2 border rounded-xl" placeholder="Opsional"></textarea></div>
        <div class="md:col-span-2 flex items-center justify-end gap-2 pt-2">
          <button type="button" class="btn" onclick="closeModal('modalForm')">Batal</button>
          <button type="submit" class="btn primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ======= TEMPLATES ======= -->
  <template id="tpl-beranda">
    <section class="relative overflow-hidden rounded-2xl brand-hero p-6 sm:p-8">
      <div class="max-w-3xl">
        <h2 class="text-2xl sm:text-3xl font-semibold">Sistem Data Prestasi FMIPA</h2>
        <p class="mt-2 text-white/90">Semua sivitas dapat mendaftar, admin memvalidasi, dan data tersimpan aman di Supabase.</p>
        <div class="mt-4 flex items-center gap-2">
          <button id="ctaAdd" class="btn light">➕ Tambah Prestasi</button>
          <button id="ctaReg" class="btn light">Daftar Registrasi</button>
        </div>
      </div>
      <div class="absolute -right-16 -bottom-16 w-64 h-64 rounded-full bg-white/10 blur-2xl"></div>
    </section>

    <!-- 4 Kartu ringkasan -->
    <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mt-6">
      <div class="card p-5"><div class="text-sm text-gray-600 mb-2">Mahasiswa</div><div id="statMahasiswa" class="text-3xl font-semibold">0</div></div>
      <div class="card p-5"><div class="text-sm text-gray-600 mb-2">Dosen</div><div id="statDosen" class="text-3xl font-semibold">0</div></div>
      <div class="card p-5"><div class="text-sm text-gray-600 mb-2">Tenaga Kependidikan</div><div id="statTendik" class="text-3xl font-semibold">0</div></div>
      <div class="card p-5"><div class="text-sm text-gray-600 mb-2">Total Prestasi</div><div id="statTotal" class="text-3xl font-semibold">0</div></div>
    </section>

    <section class="mt-6">
      <h3 class="text-lg font-semibold mb-3">Prestasi Terbaru</h3>
      <div id="listTerbaru" class="space-y-3"></div>
      <p id="emptyBeranda" class="hidden text-sm text-gray-600">Belum ada data.</p>
    </section>
  </template>

  <template id="tpl-prestasi">
    <section class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Data Prestasi</h3>
        <button id="btnOpenRegister" class="btn">Daftar Registrasi</button>
      </div>
      <div class="overflow-auto">
        <table class="min-w-[900px] w-full text-sm">
          <thead class="bg-gray-50 sticky top-0"><tr>
            <th class="p-2 text-left">Tanggal</th>
            <th class="p-2 text-left">Nama</th>
            <th class="p-2 text-left">Kategori</th>
            <th class="p-2 text-left">Prestasi</th>
            <th class="p-2 text-left">Tingkat</th>
            <th class="p-2 text-left">Jurusan</th>
            <th class="p-2 text-left">Prodi</th>
            <th class="p-2 text-left">Tahun</th>
            <th class="p-2 text-left">Status</th>
            <th class="p-2 text-left">Aksi</th>
          </tr></thead>
          <tbody id="tbodyData"></tbody>
        </table>
      </div>
    </section>
  </template>

  <template id="tpl-kelola-registrasi">
    <section class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Kelola Pendaftar</h3>
        <div class="text-sm text-gray-600">Hanya admin dapat mengubah status</div>
      </div>
      <div class="overflow-auto">
        <table class="min-w-[700px] w-full text-sm">
          <thead class="bg-gray-50 sticky top-0"><tr>
            <th class="p-2 text-left">Jenis</th>
            <th class="p-2 text-left">Nomor</th>
            <th class="p-2 text-left">Nama</th>
            <th class="p-2 text-left">Email</th>
            <th class="p-2 text-left">Status</th>
            <th class="p-2 text-left">Aksi</th>
          </tr></thead>
          <tbody id="tbodyRegs"></tbody>
        </table>
      </div>
    </section>
  </template>

  <!-- ======= SCRIPT APP ======= -->
  <script>
  // ===== Supabase init (ISI DENGAN PUNYAMU) =====
  const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR-ANON-KEY";
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ===== Utils =====
  const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>[...e.querySelectorAll(s)];
  const byId=id=>document.getElementById(id);
  byId('year').textContent=new Date().getFullYear();
  function openModal(id){byId(id).classList.remove('hidden')}
  function closeModal(id){byId(id).classList.add('hidden')}
  function showToast(msg,type='info',ms=3000){const t=byId('toast');const el=document.createElement('div');el.className='toast-item';el.style.background=type==='error'?'#991b1b':(type==='success'?'#14532d':'#0f172a');el.textContent=msg;t.appendChild(el);setTimeout(()=>el.remove(),ms);}
  const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  const fmtDate=d=>d?new Date(d).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'}):'-';

  // ===== State =====
  let USER=null, IS_ADMIN=false;
  let DATA=[], REGS=[];

  // ===== Router =====
  function setActiveNav(){
    $$('.nav').forEach(a=>a.classList.remove('active'));
    if(location.hash.startsWith('#/beranda')) $('a[href="#/beranda"]')?.classList.add('active');
    if(location.hash.startsWith('#/prestasi')) $('a[href="#/prestasi"]')?.classList.add('active');
    if(location.hash.startsWith('#/kelola-registrasi')) $('a[href="#/kelola-registrasi"]')?.classList.add('active');
  }
  function router(){
    setActiveNav();
    const h=location.hash||'#/beranda';
    if(h.startsWith('#/beranda')) renderBeranda();
    else if(h.startsWith('#/prestasi')) renderPrestasi();
    else if(h.startsWith('#/kelola-registrasi')) renderKelolaRegistrasi();
    else location.hash='#/beranda';
  }
  window.addEventListener('hashchange',router);

  // ===== Auth session =====
  async function loadSession(){
    const { data } = await supa.auth.getSession();
    USER = data.session?.user || null;
    IS_ADMIN = !!(USER?.user_metadata?.role==='admin' || USER?.app_metadata?.role==='admin' || USER?.role==='admin');
    updateAuthUI();
  }
  supa.auth.onAuthStateChange((_event, session)=>{
    USER=session?.user||null;
    IS_ADMIN = !!(USER?.user_metadata?.role==='admin' || USER?.app_metadata?.role==='admin' || USER?.role==='admin');
    updateAuthUI(); fetchAll().then(render);
  });

  function updateAuthUI(){
    const logged=!!USER;
    byId('btnAdd').classList.toggle('hidden', !logged);
    byId('btnExportCSV').classList.toggle('hidden', !IS_ADMIN);
    byId('btnLogin').classList.toggle('hidden', logged);
    byId('btnLoginMobile').classList.toggle('hidden', logged);
    byId('btnLogout').classList.toggle('hidden', !logged);
    byId('btnLogoutMobile').classList.toggle('hidden', !logged);
    byId('navKelolaReg').classList.toggle('hidden', !IS_ADMIN);
    byId('navKelolaRegMobile').classList.toggle('hidden', !IS_ADMIN);
  }

  // ===== Fetch data =====
  async function fetchPrestasi(){
    const { data, error } = await supa.from('prestasi').select('*').order('tanggal', {ascending:false}).order('id', {ascending:false});
    if(error){ showToast('Gagal memuat prestasi: '+error.message,'error'); return; }
    DATA = data||[];
  }
  async function fetchRegistrations(){
    const { data, error } = await supa.from('registrations').select('*').order('id',{ascending:false});
    if(error){ showToast('Gagal memuat registrasi: '+error.message,'error'); return; }
    REGS = data||[];
  }
  async function fetchAll(){ await Promise.all([fetchPrestasi(), fetchRegistrations()]); }

  // ===== RENDER =====
  function render(){ router(); }

  function renderBeranda(){
    const root=byId('app'); root.innerHTML='';
    root.appendChild(byId('tpl-beranda').content.cloneNode(true));
    byId('ctaAdd').onclick=()=>{ if(!USER) return openModal('modalLogin'); openPrestasiForm(); };
    byId('ctaReg').onclick=()=>openModal('modalRegister');

    // ringkasan
    const mhs=DATA.filter(x=>x.kategori==='Mahasiswa').length;
    const dos=DATA.filter(x=>x.kategori==='Dosen').length;
    const ten=DATA.filter(x=>x.kategori==='Tenaga Kependidikan').length;
    byId('statMahasiswa').textContent=mhs;
    byId('statDosen').textContent=dos;
    byId('statTendik').textContent=ten;
    byId('statTotal').textContent=DATA.length;

    const list=byId('listTerbaru');
    if(!DATA.length) byId('emptyBeranda').classList.remove('hidden');
    DATA.slice(0,6).forEach(x=>{
      const div=document.createElement('div');div.className='card p-3 flex items-start justify-between gap-3';
      div.innerHTML=`<div class="min-w-0">
        <div class="text-sm text-gray-600">${fmtDate(x.tanggal)} • <b>${esc(x.kategori)}</b> • ${esc(x.tingkat||'-')}</div>
        <div class="font-semibold truncate">${esc(x.judul)}</div>
        <div class="text-sm text-gray-700 truncate">${esc(x.nama)} — ${esc(x.jurusan||'-')}/${esc(x.prodi||'-')}</div>
      </div>
      <span class="px-2 py-0.5 rounded text-xs ${x.status==='Disetujui'?'bg-green-100 text-green-700':x.status==='Ditolak'?'bg-red-100 text-red-700':'bg-amber-100 text-amber-700'}">${esc(x.status||'-')}</span>`;
      list.appendChild(div);
    });
  }

  function renderPrestasi(){
    const root=byId('app'); root.innerHTML='';
    root.appendChild(byId('tpl-prestasi').content.cloneNode(true));
    byId('btnOpenRegister').onclick=()=>openModal('modalRegister');
    paintTable();
  }
  function paintTable(){
    const q=(byId('quickSearch').value||'').toLowerCase().trim();
    const tbody=byId('tbodyData'); tbody.innerHTML='';
    DATA.filter(x=>{
      if(!q) return true;
      const hay = `${x.nama} ${x.judul} ${x.kategori} ${x.jurusan} ${x.prodi} ${x.tingkat} ${x.status}`.toLowerCase();
      return hay.includes(q);
    }).forEach(x=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td class="p-2">${fmtDate(x.tanggal)}</td>
      <td class="p-2 font-medium">${esc(x.nama)}</td>
      <td class="p-2">${esc(x.kategori)}</td>
      <td class="p-2 min-w-[16rem]">${esc(x.judul)}</td>
      <td class="p-2">${esc(x.tingkat||'-')}</td>
      <td class="p-2">${esc(x.jurusan||'-')}</td>
      <td class="p-2">${esc(x.prodi||'-')}</td>
      <td class="p-2">${esc(x.tahun||'')}</td>
      <td class="p-2"><span class="px-2 py-0.5 rounded text-xs ${x.status==='Disetujui'?'bg-green-100 text-green-700':x.status==='Ditolak'?'bg-red-100 text-red-700':'bg-amber-100 text-amber-700'}">${esc(x.status||'-')}</span></td>
      <td class="p-2">
        ${IS_ADMIN?`
        <div class="flex items-center gap-2">
          <button class="btn primary" data-approve="${x.id}">Setujui</button>
          <button class="btn" data-reject="${x.id}">Tolak</button>
          <button class="btn" data-edit="${x.id}">Edit</button>
          <button class="btn danger" data-del="${x.id}">Hapus</button>
        </div>`:'-'}
      </td>`;
      tbody.appendChild(tr);
    });
    if(IS_ADMIN){
      $$('[data-approve]').forEach(b=>b.onclick=()=>setStatus(Number(b.dataset.approve),'Disetujui'));
      $$('[data-reject]').forEach(b=>b.onclick=()=>setStatus(Number(b.dataset.reject),'Ditolak'));
      $$('[data-del]').forEach(b=>b.onclick=()=>delPrestasi(Number(b.dataset.del)));
      $$('[data-edit]').forEach(b=>b.onclick=()=>editPrestasi(Number(b.dataset.edit)));
    }
  }

  function renderKelolaRegistrasi(){
    if(!IS_ADMIN){ location.hash='#/beranda'; return; }
    const root=byId('app'); root.innerHTML='';
    root.appendChild(byId('tpl-kelola-registrasi').content.cloneNode(true));
    const tbody=byId('tbodyRegs'); tbody.innerHTML='';
    REGS.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td class="p-2">${r.jenis}</td>
      <td class="p-2 font-medium">${esc(r.nomor)}</td>
      <td class="p-2">${esc(r.nama)}</td>
      <td class="p-2">${esc(r.email||'-')}</td>
      <td class="p-2">${r.status}</td>
      <td class="p-2">
        <div class="flex items-center gap-2">
          <button class="btn primary" data-approve="${r.id}">Setujui</button>
          <button class="btn" data-reject="${r.id}">Tolak</button>
          <button class="btn danger" data-del="${r.id}">Hapus</button>
        </div>
      </td>`;
      tbody.appendChild(tr);
    });
    $$('[data-approve]').forEach(b=>b.onclick=()=>setRegStatus(Number(b.dataset.approve),'approved'));
    $$('[data-reject]').forEach(b=>b.onclick=()=>setRegStatus(Number(b.dataset.reject),'rejected'));
    $$('[data-del]').forEach(b=>b.onclick=()=>delReg(Number(b.dataset.del)));
  }

  // ===== Actions: Prestasi =====
  function openPrestasiForm(editId=null){
    byId('formPrestasi').reset();
    byId('formPrestasi').dataset.editId = editId||'';
    byId('modalTitle').textContent = editId? 'Edit Prestasi' : 'Tambah Prestasi';
    if(editId){
      const x=DATA.find(d=>d.id===editId); if(x){
        const f=byId('formPrestasi');
        f.kategori.value=x.kategori; f.nama.value=x.nama; f.judul.value=x.judul;
        f.tingkat.value=x.tingkat||'Universitas'; f.jurusan.value=x.jurusan||'Matematika';
        f.prodi.value=x.prodi||'Matematika'; f.tahun.value=x.tahun||new Date().getFullYear();
        f.tanggal.value=x.tanggal||''; f.keterangan.value=x.keterangan||''; f.linkSertifikat.value=x.linkSertifikat||'';
      }
    }
    openModal('modalForm');
  }

  async function setStatus(id,st){
    const { error } = await supa.from('prestasi').update({status:st}).eq('id',id);
    if(error){ showToast('Gagal ubah status: '+error.message,'error'); return; }
    showToast('Status diubah ke '+st,'success'); await fetchPrestasi(); paintTable();
  }
  async function delPrestasi(id){
    if(!confirm('Hapus data ini?')) return;
    const { error } = await supa.from('prestasi').delete().eq('id',id);
    if(error){ showToast('Gagal hapus: '+error.message,'error'); return; }
    showToast('Data dihapus','success'); await fetchPrestasi(); paintTable();
  }
  function editPrestasi(id){ openPrestasiForm(id); }

  byId('formPrestasi').addEventListener('submit', async e=>{
    e.preventDefault();
    if(!USER){ showToast('Silakan login terlebih dahulu','error'); return; }
    const f=e.target; const fd=new FormData(f);
    const row=Object.fromEntries(fd.entries());
    if(!row.tanggal) row.tanggal=new Date().toISOString().slice(0,10);
    row.tahun = row.tahun? Number(row.tahun) : new Date().getFullYear();
    const editId = Number(f.dataset.editId||0);
    let res;
    if(editId){ res = await supa.from('prestasi').update(row).eq('id', editId); }
    else{ row.status = 'Menunggu Validasi'; res = await supa.from('prestasi').insert(row); }
    if(res.error){ showToast('Gagal simpan: '+res.error.message,'error'); return; }
    closeModal('modalForm'); showToast('Tersimpan','success'); await fetchPrestasi(); render();
  });

  // ===== Actions: Registrations =====
  byId('formRegister').addEventListener('submit', async e=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    const jenis=(fd.get('jenis')||'').toUpperCase();
    const nomor=(fd.get('nomor')||'').replace(/\D+/g,'');
    const nama=(fd.get('nama')||'').trim();
    const email=(fd.get('email')||'').trim();

    if(!nomor) return showToast('Nomor harus angka','error');
    if(!email) return showToast('Email wajib diisi agar bisa login','error');

    const { error } = await supa.from('registrations').insert({ jenis, nomor, nama, email, status:'pending' });
    if(error){ showToast('Gagal daftar: '+error.message,'error'); return; }
    closeModal('modalRegister'); showToast('Pendaftaran dikirim. Menunggu persetujuan admin.','success');
    await fetchRegistrations();
  });

  async function setRegStatus(id,st){
    const { error } = await supa.from('registrations').update({status:st}).eq('id',id);
    if(error){ showToast('Gagal ubah status: '+error.message,'error'); return; }
    showToast('Status pendaftar diubah','success'); await fetchRegistrations(); renderKelolaRegistrasi();
  }
  async function delReg(id){
    if(!confirm('Hapus pendaftar ini?')) return;
    const { error } = await supa.from('registrations').delete().eq('id',id);
    if(error){ showToast('Gagal hapus: '+error.message,'error'); return; }
    showToast('Pendaftar dihapus','success'); await fetchRegistrations(); renderKelolaRegistrasi();
  }

  // ===== Login flows =====
  byId('btnLogin').onclick=()=>openModal('modalLogin');
  byId('btnLoginMobile').onclick=()=>{openModal('modalLogin'); byId('mobileMenu').classList.add('hidden')}
  byId('linkOpenSignup').onclick=()=>{closeModal('modalLogin'); openModal('modalSignup')}
  byId('btnLoginNIM').onclick=()=>openModal('modalLoginNIM');
  byId('btnLoginNIMMobile').onclick=()=>{openModal('modalLoginNIM'); byId('mobileMenu').classList.add('hidden')}
  byId('btnLogout').onclick=async()=>{await supa.auth.signOut(); showToast('Logout','success')}
  byId('btnLogoutMobile').onclick=async()=>{await supa.auth.signOut(); byId('mobileMenu').classList.add('hidden'); showToast('Logout','success')}
  byId('btnHamburger').onclick=()=>{const mm=byId('mobileMenu'); const open=mm.classList.toggle('hidden')===false; byId('btnHamburger').setAttribute('aria-expanded', open?'true':'false');};

  byId('formSignup').addEventListener('submit', async e=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    const email=(fd.get('email')||'').trim();
    const password=fd.get('password');
    const { error } = await supa.auth.signUp({ email, password });
    if(error){ showToast('Gagal daftar: '+error.message,'error'); return; }
    closeModal('modalSignup'); showToast('Pendaftaran berhasil. Silakan cek email verifikasi lalu login.','success');
  });

  byId('formLogin').addEventListener('submit', async e=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    const email=(fd.get('email')||'').trim();
    const password=fd.get('password');
    const { data, error } = await supa.auth.signInWithPassword({ email, password });
    if(error){ showToast('Login gagal: '+error.message,'error'); return; }
    USER=data.user; closeModal('modalLogin'); showToast('Login berhasil','success');
    await fetchAll(); render();
  });

  byId('formLoginNIM').addEventListener('submit', async e=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    const jenis=(fd.get('jenis')||'').toUpperCase();
    const nomor=(fd.get('nomor')||'').trim().replace(/\D+/g,'');
    const { data: reg, error } = await supa.from('registrations').select('email,status').eq('jenis',jenis).eq('nomor',nomor).maybeSingle();
    if(error){ showToast('Gagal cek registrasi: '+error.message,'error'); return; }
    if(!reg){ showToast('Nomor belum terdaftar','error'); return; }
    if(reg.status!=='approved'){ showToast('Akun belum disetujui admin','error'); return; }
    if(!reg.email){ showToast('Email belum terisi. Hubungi admin.','error'); return; }
    const { error: eotp } = await supa.auth.signInWithOtp({ email: reg.email, options: { emailRedirectTo: window.location.origin }});
    if(eotp){ showToast('Gagal mengirim link: '+eotp.message,'error'); return; }
    closeModal('modalLoginNIM'); showToast('Link masuk dikirim ke '+reg.email+'. Cek email Anda.','success');
  });

  // Toolbar actions
  byId('btnAdd').onclick=()=>openPrestasiForm();
  byId('btnExportCSV').onclick=()=>{
    const cols=['id','kategori','nama','judul','tingkat','jurusan','prodi','tahun','tanggal','status','keterangan','linkSertifikat'];
    const lines=[cols.join(',')].concat(DATA.map(o=>cols.map(c=>`"${(o[c]??'').toString().replaceAll('"','""')}"`).join(',')));
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([lines.join('\n')],{type:'text/csv'})); a.download='prestasi.csv'; a.click(); URL.revokeObjectURL(a.href);
  };

  // Quick search repaint
  byId('quickSearch').addEventListener('input', ()=>{ if(location.hash.startsWith('#/prestasi')) paintTable(); });

  // ===== Init =====
  (async function init(){
    await loadSession();
    await fetchAll();
    router();
  })();
  </script>
</body>
</html>
